<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMR Alert System</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512.png">
    <link rel="shortcut icon" href="/static/icons/icon-192.png">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- iOS Specific Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fire Alert">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <link rel="apple-touch-icon-precomposed" href="/static/icons/icon-192.png">
    <link rel="apple-touch-startup-image" href="/static/icons/icon-512.png">
    
    <meta name="description" content="Emergency fire notification system for ranch communities">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: #1e293b;
            line-height: 1.6;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 24px 20px;
            min-height: 100vh;
            box-sizing: border-box;
        }
        
        .header {
            text-align: center;
            margin-bottom: 32px;
            padding: 24px 0;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }
        
        .header p {
            color: #64748b;
            font-size: 16px;
            font-weight: 500;
        }
        
        .card {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease-in-out;
        }
        
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }
        
        .alert-card {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
        }
        
        .alert-card.critical {
            border-left-color: #dc2626;
            background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
        }
        
        .alert-card.high {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fff7ed 0%, #ffffff 100%);
        }
        
        .alert-card.medium {
            border-left-color: #f97316;
            background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);
        }
        
        .alert-card.low {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fefce8 0%, #ffffff 100%);
        }
        
        .severity-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }
        
        .severity-critical {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }
        
        .severity-high {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .severity-medium {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
        }
        
        .severity-low {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn:disabled::before {
            display: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            box-shadow: 0 10px 25px -5px rgba(100, 116, 139, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 10px 25px -5px rgba(239, 68, 68, 0.4);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            background: #ffffff;
            transition: all 0.2s ease-in-out;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: #ffffff;
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #9ca3af;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
            line-height: 1.5;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 12px;
            position: relative;
        }
        
        .status-indicator::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            background: inherit;
            opacity: 0.3;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.2); opacity: 0.1; }
            100% { transform: scale(1); opacity: 0.3; }
        }
        
        .status-online {
            background: #10b981;
        }
        
        .status-offline {
            background: #ef4444;
        }
        
        .livestock-request {
            background: linear-gradient(135deg, #fff7ed 0%, #ffffff 100%);
            border-left: 4px solid #f97316;
            padding: 20px;
            margin-bottom: 16px;
            border-radius: 12px;
            border: 1px solid #fed7aa;
        }
        
        .hidden {
            display: none;
        }
        
        .tabs {
            display: flex;
            background: #ffffff;
            border-radius: 16px;
            margin-bottom: 24px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }
        
        .tab {
            flex: 1;
            background: #f8fafc;
            border: none;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            position: relative;
            color: #64748b;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .tab-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            min-width: 22px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .tab:hover:not(.active) {
            background: #e2e8f0;
            color: #475569;
        }
        
        .timestamp {
            font-size: 12px;
            color: #6b7280;
            margin-top: 12px;
            font-weight: 500;
        }
        
        .error-message {
            background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
            color: #dc2626;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border-left: 4px solid #ef4444;
            border: 1px solid #fecaca;
        }
        
        .success-message {
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
            color: #16a34a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border-left: 4px solid #22c55e;
            border: 1px solid #bbf7d0;
        }
        
        .info-message {
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
            color: #2563eb;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border-left: 4px solid #3b82f6;
            border: 1px solid #bfdbfe;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-link {
            color: #3b82f6;
            text-decoration: none;
            cursor: pointer;
            font-weight: 600;
            transition: color 0.2s ease-in-out;
        }
        
        .text-link:hover {
            color: #2563eb;
            text-decoration: underline;
        }
        
        .user-info {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
        }
        
        .user-info h3 {
            margin-bottom: 8px;
            color: #1e293b;
            font-weight: 700;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .install-prompt {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            text-align: center;
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.3);
        }
        
        .admin-alert-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }
        
        .admin-alert-actions .btn {
            flex: 1;
            font-size: 12px;
            padding: 8px 12px;
            margin: 0;
        }
        
        .admin-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .admin-controls .btn {
            flex: 0 0 auto;
            margin: 0;
        }
        
        .admin-controls select {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            background: #ffffff;
        }
        
        .alert-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            font-size: 14px;
            background: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .alert-table th,
        .alert-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .alert-table th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            font-weight: 700;
            color: #374151;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .alert-table tr:hover {
            background: #f8fafc;
        }
        
        .alert-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-active {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1d4ed8;
        }
        
        .status-resolved {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #15803d;
        }
        
        .alert-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .alert-actions .btn {
            font-size: 11px;
            padding: 6px 10px;
            margin: 0;
            min-width: auto;
        }
        
        .alert-details {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .logout-section {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            padding: 20px;
            border-radius: 12px;
            margin-top: 24px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .alert-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-number {
            display: block;
            font-size: 24px;
            font-weight: 800;
            color: #ef4444;
            margin-bottom: 4px;
        }
        
        .modal { 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100vw; 
            height: 100vh; 
            background: rgba(0, 0, 0, 0.5); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(4px);
        }
        
        .modal.hidden { 
            display: none; 
        }
        
        .modal-content { 
            min-width: 320px; 
            max-width: 95vw; 
            position: relative;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .close { 
            position: absolute; 
            right: 20px; 
            top: 16px; 
            font-size: 28px; 
            color: #6b7280; 
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease-in-out;
        }
        
        .close:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        /* Responsive improvements */
        @media (max-width: 480px) {
            .container {
                padding: 16px 12px;
                max-width: 100%;
            }
            
            .header {
                margin-bottom: 24px;
                padding: 16px 0;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            .card {
                padding: 20px 16px;
                margin-bottom: 16px;
                border-radius: 12px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 15px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 12px 14px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
        
        /* Tablet optimization */
        @media (min-width: 481px) and (max-width: 768px) {
            .container {
                max-width: 600px;
                padding: 20px 24px;
            }
        }
        
        /* Ensure proper viewport on mobile */
        @media (max-width: 480px) {
            body {
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🔥 DMR Fire Alert</h1>
            <p>Emergency Communication System</p>
        </div>

        <!-- Error/Success Messages -->
        <div id="errorDisplay" class="error-message hidden">
            <span id="errorMessage"></span>
        </div>
        
        <div id="successDisplay" class="success-message hidden">
            <span id="successMessage"></span>
        </div>

        <!-- Install Prompt (PWA) -->
        <div id="installPrompt" class="install-prompt hidden">
            <p><strong>🏜️ Add to Home Screen</strong></p>
            <p>Add to your home screen for quick access and offline use</p>
            <button class="btn btn-success" onclick="installPWA()">Install App</button>
        </div>

        <!-- User Check Form -->
        <div id="userCheckForm" class="card">
            <h2>Get Started</h2>
            <p style="margin-bottom: 15px;">Enter your email or phone number to continue:</p>
            
            <div class="form-group">
                <input type="text" id="userIdentifier" placeholder="Email or phone number" autocomplete="username">
            </div>
            
            <button class="btn" onclick="checkUser()" id="checkUserBtn">Continue</button>
            <div class="loading hidden" id="checkUserLoading"></div>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="card hidden">
            <h2>Welcome Back</h2>
            
            <div id="existingUserInfo" class="user-info"></div>
            
            <div class="form-group">
                <label for="loginPassword">Password (optional):</label>
                <input type="password" id="loginPassword" placeholder="Enter password or leave blank">
            </div>
            
            <button class="btn" onclick="login()" id="loginBtn">Sign In</button>
            <div class="loading hidden" id="loginLoading"></div>
            
            <div class="auth-toggle">
                <span class="text-link" onclick="showUserCheck()">← Back</span>
            </div>
        </div>

        <!-- Registration Form -->
        <div id="registrationForm" class="card hidden">
            <h2>Join the Alert System</h2>
            
            <div class="form-group">
                <label for="regName">Full Name *</label>
                <input type="text" id="regName" placeholder="Your full name" required>
            </div>
            
            <div class="form-group">
                <label for="regEmail">Email</label>
                <input type="email" id="regEmail" placeholder="your@email.com">
            </div>
            
            <div class="form-group">
                <label for="regPhone">Phone Number</label>
                <input type="tel" id="regPhone" placeholder="(555) 123-4567">
            </div>
            
            <div class="form-group">
                <label for="regPassword">Password (optional)</label>
                <input type="password" id="regPassword" placeholder="Create a password">
                <small style="color: #666;">Leave blank for passwordless access</small>
            </div>
            
            <div class="form-group">
                <label for="regRanch">Select Ranch *</label>
                <select id="regRanch" required>
                    <option value="">Choose your ranch...</option>
                </select>
            </div>
            
            <button class="btn" onclick="register()" id="registerBtn">Join Alert System</button>
            <div class="loading hidden" id="registerLoading"></div>
            
            <div class="auth-toggle">
                <span class="text-link" onclick="showUserCheck()">← Back</span>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainApp" class="hidden">
            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('alerts')">🔥 Alerts</button>
                <button class="tab" onclick="showTab('livestock')">🐄 Livestock</button>
                <button class="tab" onclick="showTab('admin')" id="adminTabBtn" style="display:none;">⚙️ Admin</button>
                <button class="tab" onclick="showTab('users')" id="usersTabBtn" style="display:none;">👤 Users</button>
            </div>

            <!-- Alerts Tab -->
            <div id="alertsTab">
                <div class="card">
                    <div class="alert-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="totalAlerts">0</span>
                            <span>Total Alerts</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="activeAlerts">0</span>
                            <span>Active</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="criticalAlerts">0</span>
                            <span>Critical</span>
                        </div>
                    </div>
                    <button class="btn" onclick="loadAlerts()">🔄 Refresh Alerts</button>
                </div>
                
                <div id="alertsList"></div>
            </div>

            <!-- Livestock Tab -->
            <div id="livestockTab" class="hidden">
                <div class="card">
                    <h3>🐄 Request Livestock Help</h3>
                    
                    <div class="form-group">
                        <label for="animalType">Animal Type</label>
                        <select id="animalType">
                            <option value="cattle">Cattle</option>
                            <option value="horses">Horses</option>
                            <option value="sheep">Sheep</option>
                            <option value="goats">Goats</option>
                            <option value="pigs">Pigs</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="animalCount">Number of Animals</label>
                        <input type="number" id="animalCount" min="1" placeholder="e.g. 25">
                    </div>
                    
                    <div class="form-group">
                        <label for="urgencyLevel">Urgency Level</label>
                        <select id="urgencyLevel">
                            <option value="low">Low - Planning ahead</option>
                            <option value="medium">Medium - Need help today</option>
                            <option value="high">High - Need help now</option>
                            <option value="critical">Critical - Emergency</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="helpDetails">Details</label>
                        <textarea id="helpDetails" placeholder="Describe what help you need (transportation, temporary housing, etc.)"></textarea>
                    </div>
                    
                    <button class="btn" onclick="requestLivestockHelp()">Request Help</button>
                </div>
                
                <div id="livestockRequestsList"></div>
            </div>

            <!-- Admin Tab -->
            <div id="adminTab" class="hidden">
                <div class="card">
                    <h3>🚨 Send Fire Alert</h3>
                    
                    <div class="form-group">
                        <label for="alertTitle">Alert Title</label>
                        <input type="text" id="alertTitle" placeholder="e.g. Wildfire Alert - Highway 89">
                    </div>
                    
                    <div class="form-group">
                        <label for="alertMessage">Alert Message</label>
                        <textarea id="alertMessage" placeholder="Provide detailed information about the fire alert..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="alertSeverity">Severity Level</label>
                        <select id="alertSeverity">
                            <option value="low">🟡 Low - Informational</option>
                            <option value="medium">🟠 Medium - Caution advised</option>
                            <option value="high">🔴 High - Immediate action recommended</option>
                            <option value="critical">⚫ Critical - Emergency evacuation</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="targetRanch">Target Ranch</label>
                        <select id="targetRanch">
                            <option value="all">All Ranches</option>
                        </select>
                    </div>
                    
                    <button class="btn" onclick="sendAlert()">Send Fire Alert</button>
                </div>
                
                <div class="card">
                    <h3>📊 System Statistics</h3>
                    <div id="adminStats">
                        <p>Loading statistics...</p>
                    </div>
                    <button class="btn btn-secondary" onclick="testNotification()">🔔 Test Notification</button>
                </div>
                
                <div class="card">
                    <h3>🔧 Alert Management</h3>
                    <div class="admin-controls">
                        <button class="btn btn-secondary" onclick="loadAdminAlerts()">Refresh Alerts</button>
                        <select id="alertFilter" onchange="filterAdminAlerts()">
                            <option value="all">All Alerts</option>
                            <option value="active">Active Only</option>
                            <option value="resolved">Resolved Only</option>
                        </select>
                    </div>
                    <div id="adminAlertsList">
                        <p>Click "Refresh Alerts" to load alert management data...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>🗄️ Database Management</h3>
                    <div class="admin-controls">
                        <button class="btn btn-secondary" onclick="loadDatabaseStatus()">Database Status</button>
                        <button class="btn btn-success" onclick="createDatabaseBackup()">Create Backup</button>
                    </div>
                    <div id="databaseStatus">
                        <p>Click "Database Status" to view database information...</p>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="hidden">
                <div class="card">
                    <h3>👤 User Management</h3>
                    <div id="usersList">
                        <p>Loading users...</p>
                    </div>
                    <button class="btn btn-success" onclick="showAddUserModal()">Add User</button>
                </div>
            </div>

            <!-- Logout -->
            <div class="logout-section">
                <button class="btn btn-secondary" onclick="logout()">Sign Out</button>
            </div>

            <!-- Connection Status -->
            <div class="card">
                <p>
                    <span id="connectionStatus" class="status-indicator status-offline"></span>
                    <span id="connectionText">Checking connection...</span>
                </p>
                <div id="userInfo" style="margin-top: 8px; display: none;">
                    <p style="margin: 0; font-size: 13px; color: #64748b; font-weight: 500;">
                        <span id="userName"></span>
                        <span id="userDetails" style="margin-left: 8px; font-weight: 400;"></span>
                    </p>
                </div>
                <p style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                    <span id="appVersion">App v1.0.0</span>
                    <span id="swVersion" style="margin-left: 12px;">SW v1.0.2</span>
                    <span id="updateIndicator" style="margin-left: 12px; display: none; color: #3b82f6; font-weight: 600; cursor: pointer;" onclick="manualRefresh()" title="Click to refresh app">🔄 Update Available</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal hidden">
        <div class="modal-content card">
            <span class="close" onclick="closeUserModal()">&times;</span>
            <h3 id="userModalTitle">Add User</h3>
            <div class="form-group">
                <label for="userFormName">Full Name *</label>
                <input type="text" id="userFormName" required>
            </div>
            <div class="form-group">
                <label for="userEmail">Email</label>
                <input type="email" id="userEmail">
            </div>
            <div class="form-group">
                <label for="userPhone">Phone</label>
                <input type="tel" id="userPhone">
            </div>
            <div class="form-group">
                <label for="userPassword">Password</label>
                <input type="password" id="userPassword" placeholder="Leave blank to keep unchanged">
            </div>
            <div class="form-group">
                <label for="userRanch">Ranch *</label>
                <select id="userRanch"></select>
            </div>
            <div class="form-group">
                <label for="userIsAdmin"><input type="checkbox" id="userIsAdmin"> Admin</label>
            </div>
            <button class="btn btn-success" id="userModalSaveBtn" onclick="saveUser()">Save</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging.js';
        
        // Make Firebase available globally
        window.firebaseApp = null;
        window.firebaseMessaging = null;
        window.initializeFirebaseApp = function(config) {
            try {
                window.firebaseApp = initializeApp(config.firebase);
                window.firebaseMessaging = getMessaging(window.firebaseApp);
                console.log('Firebase initialized successfully');
                return true;
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                return false;
            }
        };
        
        window.getFirebaseToken = async function(vapidKey) {
            if (!window.firebaseMessaging) return null;
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const token = await getToken(window.firebaseMessaging, { vapidKey });
                    console.log('FCM Token:', token);
                    return token;
                } else {
                    console.log('Notification permission denied');
                    return null;
                }
            } catch (error) {
                console.error('Error getting Firebase token:', error);
                return null;
            }
        };
        
        window.setupFirebaseMessaging = function(onMessageCallback) {
            if (!window.firebaseMessaging) return;
            
            onMessage(window.firebaseMessaging, (payload) => {
                console.log('Message received in foreground:', payload);
                if (onMessageCallback) {
                    onMessageCallback(payload);
                }
            });
        };
    </script>

    <script>
        // Global variables
        let currentUser = null;
        let deferredPrompt = null;
        let swRegistration = null;

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkConnection();
            setupPWA();
            loadConfig();
            
            // Check for existing session
            const savedUser = localStorage.getItem('ranchFireAlertUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    // Validate session with server
                    validateSession();
                } catch (error) {
                    console.error('Error loading saved session:', error);
                    localStorage.removeItem('ranchFireAlertUser');
                    showUserCheck();
                }
            } else {
                showUserCheck();
            }
            
            // Set up periodic tasks
            setInterval(checkConnection, 10000);
            
            // Set up periodic alert checking
            setInterval(checkForNewAlerts, 30000); // Check every 30 seconds
            
            // Periodic service worker update check (more frequent for mobile)
            setInterval(() => {
                if (swRegistration) {
                    swRegistration.update().catch(error => {
                        console.log('Service Worker update check failed:', error);
                    });
                }
            }, 1000 * 60 * 5); // Check every 5 minutes
            
            // Periodic PWA installation check (in case beforeinstallprompt was missed)
            setInterval(() => {
                if (!deferredPrompt && !window.matchMedia('(display-mode: standalone)').matches) {
                    // Check if user has already dismissed the install prompt for this session
                    const hasDismissedInstall = localStorage.getItem('pwaInstallDismissed');
                    if (!hasDismissedInstall) {
                        checkPWACriteria();
                    }
                }
            }, 30000); // Check every 30 seconds
            
            // Initial PWA check after a short delay to ensure everything is loaded
            setTimeout(() => {
                console.log('Performing initial PWA criteria check...');
                checkPWACriteria();
            }, 2000);
            
            // Force update check on page visibility change (when user returns to app)
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && swRegistration) {
                    console.log('Page became visible, checking for updates...');
                    swRegistration.update().catch(error => {
                        console.log('Service Worker update check failed:', error);
                    });
                }
            });
        });

        // Load configuration from backend
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                if (config.firebase && config.firebase.apiKey !== 'demo-api-key') {
                    initializeFirebase(config);
                } else {
                    console.log('Firebase configuration not available - PWA features limited');
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Initialize Firebase
        function initializeFirebase(config) {
            try {
                if (window.initializeFirebaseApp && window.initializeFirebaseApp(config)) {
                    
                    if ('serviceWorker' in navigator) {
                        // Register both service workers
                        Promise.all([
                            navigator.serviceWorker.register('/static/sw.js'),
                            navigator.serviceWorker.register('/firebase-messaging-sw.js')
                        ]).then(([swReg, firebaseReg]) => {
                            swRegistration = swReg;
                            console.log('Service Workers registered successfully');
                            setupServiceWorkerUpdates(swReg);
                            updateVersionDisplay();
                            setupMessaging(config.vapidKey);
                        }).catch(error => {
                            console.error('Service Worker registration failed:', error);
                            // Continue without service workers
                            setupMessaging(config.vapidKey);
                        });
                    } else {
                        setupMessaging(config.vapidKey);
                    }
                } else {
                    console.log('Firebase initialization failed');
                }
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }
        }

        // Set up service worker update handling
        function setupServiceWorkerUpdates(registration) {
            let refreshing = false;
            
            // Handle service worker updates
            registration.addEventListener('updatefound', () => {
                console.log('Service Worker update found');
                const newWorker = registration.installing;
                
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        // New service worker is installed and ready
                        showUpdateNotification();
                    }
                });
            });
            
            // Handle controller change (when new service worker takes over)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    console.log('New service worker activated, refreshing page...');
                    window.location.reload();
                }
            });
            
            // Check for updates periodically
            setInterval(() => {
                registration.update().catch(error => {
                    console.log('Service Worker update check failed:', error);
                });
            }, 1000 * 60 * 60); // Check every hour
        }
        
        // Show update notification to user
        function showUpdateNotification() {
            // Remove any existing notification
            const existingNotification = document.getElementById('updateNotification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Show update indicator in connection status pane
            const updateIndicator = document.getElementById('updateIndicator');
            if (updateIndicator) {
                updateIndicator.style.display = 'inline';
            }
            
            // Create update notification element
            const updateNotification = document.createElement('div');
            updateNotification.id = 'updateNotification';
            updateNotification.className = 'card';
            updateNotification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 10000;
                max-width: 90%;
                width: 400px;
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                color: white;
                box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
                animation: slideIn 0.3s ease-out;
                border: none;
            `;
            
            updateNotification.innerHTML = `
                <div style="text-align: center;">
                    <h4 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 600;">🔄 App Update Available</h4>
                    <p style="margin: 0 0 16px 0; font-size: 14px; opacity: 0.9;">A new version with improved layout is ready to install</p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button id="updateNowBtn" style="
                            background: rgba(255,255,255,0.2);
                            border: 1px solid rgba(255,255,255,0.3);
                            color: white;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 14px;
                            transition: all 0.2s ease;
                            flex: 1;
                            max-width: 120px;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                           onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            Update Now
                        </button>
                        <button id="refreshBtn" style="
                            background: rgba(255,255,255,0.1);
                            border: 1px solid rgba(255,255,255,0.2);
                            color: white;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 14px;
                            transition: all 0.2s ease;
                            flex: 1;
                            max-width: 120px;
                        " onmouseover="this.style.background='rgba(255,255,255,0.2)'" 
                           onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                            Refresh
                        </button>
                    </div>
                </div>
            `;
            
            // Add event listeners to buttons
            setTimeout(() => {
                const updateNowBtn = document.getElementById('updateNowBtn');
                const refreshBtn = document.getElementById('refreshBtn');
                
                if (updateNowBtn) {
                    updateNowBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Update Now button clicked');
                        applyUpdate();
                    });
                }
                
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Refresh button clicked');
                        manualRefresh();
                    });
                }
            }, 100);
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(-50%) translateY(-100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(-50%) translateY(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(-50%) translateY(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(-50%) translateY(-100%);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
            
            // Add to page
            document.body.appendChild(updateNotification);
            
            // Auto-hide after 60 seconds (longer for mobile)
            setTimeout(() => {
                if (updateNotification.parentNode) {
                    updateNotification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => {
                        if (updateNotification.parentNode) {
                            updateNotification.remove();
                        }
                    }, 300);
                }
            }, 60000);
        }
        
        // Manual refresh function
        function manualRefresh() {
            console.log('Manual refresh triggered');
            console.log('Current URL:', window.location.href);
            console.log('Service Worker registration:', swRegistration ? 'available' : 'not available');
            
            try {
                // Show a brief loading message
                const updateIndicator = document.getElementById('updateIndicator');
                if (updateIndicator) {
                    updateIndicator.textContent = '🔄 Refreshing...';
                    updateIndicator.style.color = '#10b981';
                }
                
                // Try to clear any caches first
                if ('caches' in window) {
                    caches.keys().then(cacheNames => {
                        console.log('Found caches:', cacheNames);
                        return Promise.all(
                            cacheNames.map(cacheName => {
                                console.log('Deleting cache:', cacheName);
                                return caches.delete(cacheName);
                            })
                        );
                    }).then(() => {
                        console.log('Caches cleared, reloading page...');
                        // Small delay to show the "Refreshing..." message
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                    }).catch(error => {
                        console.error('Error clearing caches:', error);
                        window.location.reload();
                    });
                } else {
                    console.log('Cache API not available, reloading directly...');
                    window.location.reload();
                }
            } catch (error) {
                console.error('Error in manual refresh:', error);
                // Fallback to simple reload
                window.location.reload();
            }
        }
        
        // Make manualRefresh globally accessible
        window.manualRefresh = manualRefresh;
        
        // Apply service worker update
        function applyUpdate() {
            if (swRegistration && swRegistration.waiting) {
                // Hide update indicator
                const updateIndicator = document.getElementById('updateIndicator');
                if (updateIndicator) {
                    updateIndicator.style.display = 'none';
                }
                
                // Send message to service worker to skip waiting
                swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
                
                // Show loading state
                const updateNotification = document.getElementById('updateNotification');
                if (updateNotification) {
                    updateNotification.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <div class="loading" style="margin: 0 auto 12px auto;"></div>
                            <p style="margin: 0; font-size: 14px;">Updating...</p>
                        </div>
                    `;
                }
            }
        }
        
        // Update version display
        function updateVersionDisplay() {
            // Update app version
            const appVersionElement = document.getElementById('appVersion');
            if (appVersionElement) {
                appVersionElement.textContent = 'App v1.0.0';
            }
            
            // Update service worker version
            if (swRegistration && swRegistration.active) {
                const channel = new MessageChannel();
                channel.port1.onmessage = (event) => {
                    const swVersionElement = document.getElementById('swVersion');
                    if (swVersionElement && event.data.version) {
                        swVersionElement.textContent = `SW v${event.data.version}`;
                    }
                };
                
                swRegistration.active.postMessage({ type: 'GET_VERSION' }, [channel.port2]);
            }
            
            // Check for waiting service worker
            checkForWaitingServiceWorker();
        }
        
        // Check for waiting service worker and show indicator
        function checkForWaitingServiceWorker() {
            if (swRegistration && swRegistration.waiting) {
                const updateIndicator = document.getElementById('updateIndicator');
                if (updateIndicator) {
                    updateIndicator.style.display = 'inline';
                }
            }
        }

        // Set up Firebase messaging
        function setupMessaging(vapidKey) {
            if (!window.firebaseMessaging || !window.setupFirebaseMessaging) return;
            
            // Handle foreground messages
            window.setupFirebaseMessaging((payload) => {
                const notificationTitle = payload.notification?.title || 'Fire Alert';
                const notificationOptions = {
                    body: payload.notification?.body || 'New alert received',
                    icon: '/static/icons/icon-192.png',
                    badge: '/static/icons/icon-192.png',
                    tag: 'fire-alert',
                    requireInteraction: true
                };
                
                if (swRegistration) {
                    swRegistration.showNotification(notificationTitle, notificationOptions);
                }
                
                // Refresh alerts if we're on the alerts tab
                if (!document.getElementById('alertsTab').classList.contains('hidden')) {
                    loadAlerts();
                }
            });
        }

        // Request notification permission and get token
        async function requestNotificationPermission() {
            console.log('requestNotificationPermission started');
            
            if (!window.getFirebaseToken) {
                console.log('Firebase not available - skipping notification setup');
                return null;
            }
            
            try {
                console.log('Loading config to get VAPID key...');
                // Load config to get VAPID key
                const response = await fetch('/api/config');
                const config = await response.json();
                console.log('Config loaded, VAPID key available:', !!config.vapidKey);
                
                if (config.vapidKey && config.vapidKey !== 'demo-vapid-key') {
                    console.log('Getting Firebase token...');
                    const token = await window.getFirebaseToken(config.vapidKey);
                    console.log('Firebase token received:', token ? 'yes' : 'no');
                    return token;
                } else {
                    console.log('VAPID key not configured - skipping notifications');
                    return null;
                }
            } catch (error) {
                console.error('Error setting up notifications:', error);
                return null;
            }
        }

        // PWA Installation
        function setupPWA() {
            console.log('Setting up PWA installation...');
            
            // Check if PWA is already installed
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                console.log('PWA is already installed');
                return;
            }
            
            // Check if browser supports PWA installation
            if (!('serviceWorker' in navigator)) {
                console.log('Service Worker not supported - PWA installation not available');
                return;
            }
            
            // Check if user has already dismissed the install prompt for this session
            const hasDismissedInstall = localStorage.getItem('pwaInstallDismissed');
            if (hasDismissedInstall) {
                console.log('User has already dismissed PWA install prompt for this session');
                return;
            }
            
            // Listen for beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('beforeinstallprompt event fired');
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install prompt
                showInstallPrompt();
            });
            
            // Handle app installed event
            window.addEventListener('appinstalled', (e) => {
                console.log('PWA was installed');
                hideInstallPrompt();
                deferredPrompt = null;
            });
            
            // Check if we missed the beforeinstallprompt event
            // This can happen if the event fires before our listener is attached
            setTimeout(() => {
                if (!deferredPrompt) {
                    console.log('No beforeinstallprompt event received - checking PWA criteria');
                    checkPWACriteria();
                }
            }, 1000);
        }
        
        // Show install prompt
        function showInstallPrompt() {
            const installPrompt = document.getElementById('installPrompt');
            if (installPrompt) {
                installPrompt.classList.remove('hidden');
                console.log('Install prompt shown');
            } else {
                console.error('Install prompt element not found');
            }
        }
        
        // Hide install prompt
        function hideInstallPrompt() {
            const installPrompt = document.getElementById('installPrompt');
            if (installPrompt) {
                installPrompt.classList.add('hidden');
                console.log('Install prompt hidden');
                
                // Remember that user dismissed the install prompt for this session
                localStorage.setItem('pwaInstallDismissed', 'true');
            }
        }
        
        // Check PWA installation criteria
        function checkPWACriteria() {
            console.log('Checking PWA installation criteria...');
            
            // Check for manifest
            const manifestLink = document.querySelector('link[rel="manifest"]');
            const hasManifest = !!manifestLink;
            
            // Check for service worker support
            const hasServiceWorker = 'serviceWorker' in navigator;
            
            // Check for HTTPS or localhost
            const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
            
            // Check for icons with sizes
            const icon192 = document.querySelector('link[rel="icon"][sizes="192x192"]');
            const icon512 = document.querySelector('link[rel="icon"][sizes="512x512"]');
            const hasIcons = !!(icon192 || icon512);
            
            // Check if not already installed
            const isNotAlreadyInstalled = !window.matchMedia('(display-mode: standalone)').matches && window.navigator.standalone !== true;
            
            const criteria = {
                hasManifest,
                hasServiceWorker,
                isHTTPS,
                hasIcons,
                isNotAlreadyInstalled
            };
            
            console.log('PWA Criteria:', criteria);
            console.log('Icon details:', {
                icon192: icon192?.href,
                icon512: icon512?.href,
                allIcons: Array.from(document.querySelectorAll('link[rel="icon"]')).map(icon => ({
                    href: icon.href,
                    sizes: icon.sizes?.value,
                    type: icon.type
                }))
            });
            
            // If all criteria are met but no prompt, try to show manual install option
            if (Object.values(criteria).every(Boolean)) {
                // Check if user has already dismissed the install prompt for this session
                const hasDismissedInstall = localStorage.getItem('pwaInstallDismissed');
                if (hasDismissedInstall) {
                    console.log('User has already dismissed PWA install prompt for this session');
                    return;
                }
                
                console.log('All PWA criteria met - showing manual install option');
                showManualInstallOption();
            } else {
                const failedCriteria = Object.entries(criteria).filter(([, met]) => !met);
                console.log('PWA criteria not met:', failedCriteria);
                
                // Provide specific guidance for failed criteria
                failedCriteria.forEach(([criterion, met]) => {
                    if (!met) {
                        switch (criterion) {
                            case 'hasManifest':
                                console.warn('Missing manifest.json link');
                                break;
                            case 'hasServiceWorker':
                                console.warn('Service Worker not supported in this browser');
                                break;
                            case 'isHTTPS':
                                console.warn('HTTPS required for PWA installation');
                                break;
                            case 'hasIcons':
                                console.warn('Missing icon links with sizes attribute');
                                break;
                            case 'isNotAlreadyInstalled':
                                console.warn('PWA is already installed');
                                break;
                        }
                    }
                });
            }
        }
        
        // Show manual install option for browsers that don't support beforeinstallprompt
        function showManualInstallOption() {
            const installPrompt = document.getElementById('installPrompt');
            if (installPrompt && !deferredPrompt) {
                installPrompt.innerHTML = `
                    <p><strong>🏜️ Add to Home Screen</strong></p>
                    <p>This app can be installed on your device for quick access and offline use.</p>
                    <div style="margin: 15px 0; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <p style="margin: 0 0 8px 0; font-size: 14px;"><strong>Installation Instructions:</strong></p>
                        <p style="margin: 0; font-size: 13px;">
                            <strong>Chrome/Edge:</strong> Tap the menu (⋮) → "Add to Home screen"<br>
                            <strong>Safari:</strong> Tap the share button → "Add to Home Screen"<br>
                            <strong>Firefox:</strong> Tap the menu (☰) → "Install App"
                        </p>
                    </div>
                    <button class="btn btn-success" onclick="hideInstallPrompt()">Got it!</button>
                `;
                installPrompt.classList.remove('hidden');
            }
        }

        // Install PWA
        async function installPWA() {
            console.log('Install PWA function called');
            
            if (deferredPrompt) {
                try {
                    console.log('Showing native install prompt...');
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    console.log('Install prompt outcome:', outcome);
                    
                    if (outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                        showSuccess('App installed successfully!');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                } catch (error) {
                    console.error('Error during PWA installation:', error);
                    showError('Installation failed. Please try again.');
                } finally {
                    deferredPrompt = null;
                    hideInstallPrompt();
                }
            } else {
                console.log('No deferred prompt available');
                showManualInstallOption();
            }
        }

        // Connection status check
        function checkConnection() {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (navigator.onLine) {
                indicator.className = 'status-indicator status-online';
                text.textContent = 'Connected';
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = 'Offline';
            }
        }

        // Utility functions
        function hideAllForms() {
            const forms = ['userCheckForm', 'loginForm', 'registrationForm', 'mainApp'];
            forms.forEach(form => {
                document.getElementById(form).classList.add('hidden');
            });
        }

        function showError(message) {
            const errorDisplay = document.getElementById('errorDisplay');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorDisplay.classList.remove('hidden');
            
            // Hide success message
            document.getElementById('successDisplay').classList.add('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorDisplay.classList.add('hidden');
            }, 5000);
        }

        function showSuccess(message) {
            const successDisplay = document.getElementById('successDisplay');
            const successMessage = document.getElementById('successMessage');
            
            successMessage.textContent = message;
            successDisplay.classList.remove('hidden');
            
            // Hide error message
            document.getElementById('errorDisplay').classList.add('hidden');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                successDisplay.classList.add('hidden');
            }, 3000);
        }

        function setLoading(elementId, isLoading) {
            const btn = document.getElementById(elementId);
            const loading = document.getElementById(elementId.replace('Btn', 'Loading'));
            
            if (isLoading) {
                btn.classList.add('hidden');
                loading.classList.remove('hidden');
            } else {
                btn.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        }
        
        function showLoading(loadingId, buttonId) {
            const btn = document.getElementById(buttonId);
            const loading = document.getElementById(loadingId);
            
            if (btn) btn.classList.add('hidden');
            if (loading) loading.classList.remove('hidden');
        }
        
        function hideLoading(loadingId, buttonId) {
            const btn = document.getElementById(buttonId);
            const loading = document.getElementById(loadingId);
            
            if (btn) btn.classList.remove('hidden');
            if (loading) loading.classList.add('hidden');
        }

        // Authentication functions
        function showUserCheck() {
            hideAllForms();
            document.getElementById('userCheckForm').classList.remove('hidden');
            document.getElementById('userIdentifier').value = '';
            document.getElementById('userIdentifier').focus();
        }

        async function checkUser() {
            const identifier = document.getElementById('userIdentifier').value.trim();
            
            if (!identifier) {
                showError('Please enter your email or phone number');
                return;
            }
            
            setLoading('checkUserBtn', true);
            
            try {
                const response = await fetch('/api/check-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.exists) {
                        showLogin(result.user);
                    } else {
                        showRegistration(identifier);
                    }
                } else {
                    throw new Error(result.error || 'User check failed');
                }
                
            } catch (error) {
                console.error('Check user error:', error);
                showError('Error checking user: ' + error.message);
            } finally {
                setLoading('checkUserBtn', false);
            }
        }

        function showLogin(userData) {
            hideAllForms();
            
            const loginForm = document.getElementById('loginForm');
            const userInfo = document.getElementById('existingUserInfo');
            
            userInfo.innerHTML = `
                <h4>${userData.name}</h4>
                <p style="margin: 5px 0; color: #666;">${userData.email || userData.phone}</p>
                <p style="margin: 5px 0; color: #666;">${userData.ranch_name}</p>
            `;
            
            loginForm.classList.remove('hidden');
            document.getElementById('loginPassword').focus();
        }

        async function login() {
            console.log('Login function started');
            const password = document.getElementById('loginPassword').value;
            
            // Get identifier from the user check form since currentUser might not be set yet
            const identifier = document.getElementById('userIdentifier').value.trim();
            
            if (!identifier) {
                showError('Please enter your email or phone number');
                return;
            }
            
            try {
                console.log('Showing loading state...');
                showLoading('loginLoading', 'loginBtn');
                
                console.log('Making login request...');
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        identifier: identifier,
                        password: password,
                        fcm_token: null // Skip FCM token for now
                    })
                });
                
                console.log('Login response received, status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Login result:', result.success ? 'success' : 'failed');
                
                if (result.success) {
                    console.log('Login successful, updating user data...');
                    currentUser = result.user;
                    localStorage.setItem('ranchFireAlertUser', JSON.stringify(currentUser));
                    
                    // Request notification permission
                    if ('Notification' in window && Notification.permission === 'default') {
                        console.log('Requesting notification permission...');
                        Notification.requestPermission().then(permission => {
                            console.log('Notification permission:', permission);
                        });
                    }
                    
                    console.log('Showing main app...');
                    showMainApp();
                } else {
                    throw new Error(result.error || 'Login failed');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed: ' + error.message);
            } finally {
                console.log('Login function finished, hiding loading state...');
                hideLoading('loginLoading', 'loginBtn');
            }
        }

        function showRegistration(identifier = '') {
            hideAllForms();
            loadRanches();
            
            const registrationForm = document.getElementById('registrationForm');
            
            // Pre-fill identifier if provided
            if (identifier) {
                if (identifier.includes('@')) {
                    document.getElementById('regEmail').value = identifier;
                } else {
                    document.getElementById('regPhone').value = identifier;
                }
            }
            
            registrationForm.classList.remove('hidden');
            document.getElementById('regName').focus();
        }

        async function loadRanches() {
            try {
                const response = await fetch('/api/ranches');
                const result = await response.json();
                
                if (result.success) {
                    const ranchSelect = document.getElementById('regRanch');
                    const targetRanchSelect = document.getElementById('targetRanch');
                    
                    // Clear existing options (except first)
                    ranchSelect.innerHTML = '<option value="">Choose your ranch...</option>';
                    if (targetRanchSelect) {
                        targetRanchSelect.innerHTML = '<option value="all">All Ranches</option>';
                    }
                    
                    result.ranches.forEach(ranch => {
                        const option = document.createElement('option');
                        option.value = ranch.id;
                        option.textContent = ranch.name;
                        ranchSelect.appendChild(option);
                        
                        if (targetRanchSelect) {
                            const targetOption = document.createElement('option');
                            targetOption.value = ranch.id;
                            targetOption.textContent = ranch.name;
                            targetRanchSelect.appendChild(targetOption);
                        }
                    });
                } else {
                    console.error('Failed to load ranches:', result.error);
                }
            } catch (error) {
                console.error('Error loading ranches:', error);
            }
        }

        async function register() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const password = document.getElementById('regPassword').value;
            const ranchId = document.getElementById('regRanch').value;
            
            // Validation
            if (!name) {
                showError('Please enter your full name');
                return;
            }
            
            if (!email && !phone) {
                showError('Please enter either an email or phone number');
                return;
            }
            
            if (!ranchId) {
                showError('Please select your ranch');
                return;
            }
            
            setLoading('registerBtn', true);
            
            try {
                // Get FCM token for notifications
                const fcmToken = await requestNotificationPermission();
                
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        email: email || null,
                        phone: phone || null,
                        password: password || null,
                        ranch_id: parseInt(ranchId),
                        fcm_token: fcmToken
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.user;
                    // Save user session to localStorage
                    localStorage.setItem('ranchFireAlertUser', JSON.stringify(currentUser));
                    showSuccess('Registration successful! Welcome to the alert system.');
                    showMainApp();
                } else {
                    throw new Error(result.error || 'Registration failed');
                }
                
            } catch (error) {
                console.error('Registration error:', error);
                showError('Registration failed: ' + error.message);
            } finally {
                setLoading('registerBtn', false);
            }
        }

        // Main application functions
        function showMainApp() {
            document.getElementById('userCheckForm').classList.add('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registrationForm').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userDetails').textContent = `${currentUser.email || currentUser.phone} • ${currentUser.ranch_name || 'Unknown Ranch'}`;
            
            // Show user info in connection status pane
            const userInfoDiv = document.getElementById('userInfo');
            if (userInfoDiv) {
                userInfoDiv.style.display = 'block';
            }
            
            // Show admin tabs if user is admin
            if (currentUser.is_admin) {
                document.getElementById('adminTabBtn').style.display = 'block';
                document.getElementById('usersTabBtn').style.display = 'block';
            }
            
            // Load initial data
            loadAlerts();
            loadLivestockRequests();
            
            // Start periodic alert checking
            console.log('Starting periodic alert checking...');
            setInterval(checkForNewAlerts, 30000); // Check every 30 seconds
            
            // Request notification permission if not already granted
            if ('Notification' in window && Notification.permission === 'default') {
                console.log('Requesting notification permission on app start...');
                Notification.requestPermission().then(permission => {
                    console.log('Notification permission result:', permission);
                });
            }
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.getElementById('alertsTab').classList.add('hidden');
            document.getElementById('livestockTab').classList.add('hidden');
            document.getElementById('adminTab').classList.add('hidden');
            document.getElementById('usersTab').classList.add('hidden');
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load appropriate data for each tab
            if (tabName === 'alerts') {
                loadAlerts();
            } else if (tabName === 'livestock') {
                loadLivestockRequests();
            } else if (tabName === 'admin') {
                loadAdminStats();
            } else if (tabName === 'users') {
                loadUsers();
            }
        }

        // Alerts functions
        async function loadAlerts() {
            try {
                const url = currentUser ? `/api/alerts?user_id=${currentUser.id}` : '/api/alerts';
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayAlerts(result.alerts);
                    updateAlertStats(result.alerts);
                    
                    // Set the baseline alert count for notifications
                    const activeAlerts = result.alerts.filter(alert => alert.status === 'active');
                    lastAlertCount = activeAlerts.length;
                    console.log(`Initial alert count set to: ${lastAlertCount}`);
                } else {
                    throw new Error(result.error || 'Failed to load alerts');
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
                showError('Failed to load alerts: ' + error.message);
            }
        }
        
        // Test notification function (for debugging)
        function testNotification() {
            console.log('Testing notification...');
            const testAlert = {
                id: 'test',
                title: 'Test Alert',
                message: 'This is a test notification to verify the system is working.',
                severity: 'medium',
                status: 'active'
            };
            showSystemNotification(testAlert);
        }

        function displayAlerts(alerts) {
            const alertsList = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = `
                    <div class="card">
                        <p style="text-align: center; color: #666;">No fire alerts at this time</p>
                    </div>
                `;
                return;
            }
            
            alertsList.innerHTML = alerts.map(alert => `
                <div class="card alert-card ${alert.severity}" data-alert-id="${alert.id}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div class="severity-badge severity-${alert.severity}">
                            ${alert.severity.toUpperCase()}
                        </div>
                        <span class="alert-status status-${alert.status}">
                            ${alert.status}
                        </span>
                    </div>
                    <h3>${alert.title}</h3>
                    <p style="margin: 10px 0;">${alert.message}</p>
                    <div class="timestamp">
                        ${new Date(alert.created_at).toLocaleString()}
                    </div>
                    ${currentUser && currentUser.is_admin ? `
                        <div class="admin-alert-actions">
                            <button class="btn btn-secondary" onclick="editAlert(${alert.id})">✏️ Edit</button>
                            ${alert.status === 'active' ? 
                                `<button class="btn btn-success" onclick="resolveAlert(${alert.id})">✅ Resolve</button>` :
                                `<button class="btn btn-secondary" onclick="reopenAlert(${alert.id})">🔄 Re-open</button>`
                            }
                            <button class="btn btn-danger" onclick="deleteAlert(${alert.id})">🗑️ Delete</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function updateAlertStats(alerts) {
            const totalAlerts = alerts.length;
            const activeAlerts = alerts.filter(alert => alert.status === 'active').length;
            const resolvedAlerts = alerts.filter(alert => alert.status === 'resolved').length;
            const criticalAlerts = alerts.filter(alert => alert.severity === 'critical').length;
            
            document.getElementById('totalAlerts').textContent = totalAlerts;
            document.getElementById('activeAlerts').textContent = activeAlerts;
            document.getElementById('criticalAlerts').textContent = criticalAlerts;
            
            // Update tab badges
            updateTabBadges(alerts);
        }
        
        function updateTabBadges(alerts) {
            // Update alerts tab badge
            const alertsTab = document.querySelector('.tab[onclick="showTab(\'alerts\')"]');
            const activeAlerts = alerts.filter(alert => alert.status === 'active').length;
            
            if (alertsTab) {
                // Remove existing badge
                const existingBadge = alertsTab.querySelector('.tab-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
                
                // Add new badge if there are active alerts
                if (activeAlerts > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'tab-badge';
                    badge.textContent = activeAlerts;
                    alertsTab.appendChild(badge);
                }
            }
            
            // Update document title and favicon badge
            updateDocumentBadge(activeAlerts);
        }
        
        function updateDocumentBadge(alertCount) {
            // Update document title
            if (alertCount > 0) {
                document.title = `(${alertCount}) 🔥 DMR Fire Alert`;
            } else {
                document.title = '🔥 DMR Fire Alert';
            }
            
            // Update favicon badge (if supported)
            if ('setAppBadge' in navigator) {
                navigator.setAppBadge(alertCount).catch(error => {
                    console.log('App badge not supported:', error);
                });
            }
            
            // Update service worker badge if available
            if (swRegistration && swRegistration.active) {
                swRegistration.active.postMessage({
                    type: 'UPDATE_BADGE',
                    count: alertCount
                });
            }
        }

        // Livestock functions
        async function loadLivestockRequests() {
            try {
                const url = currentUser ? `/api/livestock-requests?user_id=${currentUser.id}` : '/api/livestock-requests';
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayLivestockRequests(result.requests);
                } else {
                    throw new Error(result.error || 'Failed to load livestock requests');
                }
            } catch (error) {
                console.error('Error loading livestock requests:', error);
                showError('Failed to load livestock requests: ' + error.message);
            }
        }

        function displayLivestockRequests(requests) {
            const requestsList = document.getElementById('livestockRequestsList');
            
            if (requests.length === 0) {
                requestsList.innerHTML = `
                    <div class="card">
                        <p style="text-align: center; color: #666;">No livestock help requests</p>
                    </div>
                `;
                return;
            }
            
            requestsList.innerHTML = requests.map(request => `
                <div class="livestock-request">
                    <h4>${request.user_name} - ${request.animal_type} (${request.animal_count})</h4>
                    <p><strong>Urgency:</strong> ${request.urgency_level.toUpperCase()}</p>
                    <p>${request.details}</p>
                    <div class="timestamp">
                        Requested: ${new Date(request.created_at).toLocaleString()}
                    </div>
                    ${request.user_id !== currentUser?.id ? `
                        <button class="btn btn-success" onclick="offerHelp(${request.id})">
                            Offer Help
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        async function requestLivestockHelp() {
            const animalType = document.getElementById('animalType').value;
            const animalCount = document.getElementById('animalCount').value;
            const urgencyLevel = document.getElementById('urgencyLevel').value;
            const details = document.getElementById('helpDetails').value.trim();
            
            if (!animalCount || animalCount <= 0) {
                showError('Please enter a valid number of animals');
                return;
            }
            
            if (!details) {
                showError('Please provide details about the help needed');
                return;
            }
            
            try {
                const response = await fetch('/api/livestock-requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        animal_type: animalType,
                        animal_count: parseInt(animalCount),
                        urgency_level: urgencyLevel,
                        details
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Livestock help request submitted successfully!');
                    
                    // Clear form
                    document.getElementById('animalCount').value = '';
                    document.getElementById('helpDetails').value = '';
                    
                    // Reload requests
                    loadLivestockRequests();
                } else {
                    throw new Error(result.error || 'Failed to submit request');
                }
                
            } catch (error) {
                console.error('Error submitting livestock request:', error);
                showError('Failed to submit request: ' + error.message);
            }
        }

        async function offerHelp(requestId) {
            try {
                const response = await fetch(`/api/livestock-requests/${requestId}/help`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.id })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message || 'Help offer sent! The requester will be notified.');
                } else {
                    throw new Error(result.error || 'Failed to offer help');
                }
                
            } catch (error) {
                console.error('Error offering help:', error);
                showError('Failed to offer help: ' + error.message);
            }
        }

        // Admin functions
        async function loadAdminStats() {
            if (!currentUser || !currentUser.is_admin) return;
            
            try {
                const response = await fetch(`/api/admin/stats?user_id=${currentUser.id}`);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.stats;
                    document.getElementById('adminStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #d32f2f;">${stats.total_users}</div>
                                <div style="font-size: 12px; color: #666;">Total Users</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #d32f2f;">${stats.total_alerts}</div>
                                <div style="font-size: 12px; color: #666;">Total Alerts</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #1976d2;">${stats.active_alerts}</div>
                                <div style="font-size: 12px; color: #666;">Active Alerts</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #388e3c;">${stats.resolved_alerts}</div>
                                <div style="font-size: 12px; color: #666;">Resolved Alerts</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #ff9800;">${stats.livestock_requests}</div>
                                <div style="font-size: 12px; color: #666;">Help Requests</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #4caf50;">${stats.active_ranches}</div>
                                <div style="font-size: 12px; color: #666;">Active Ranches</div>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(result.error || 'Failed to load admin stats');
                }
            } catch (error) {
                console.error('Error loading admin stats:', error);
                document.getElementById('adminStats').innerHTML = '<p style="color: #f44336;">Failed to load statistics</p>';
            }
        }

        async function sendAlert() {
            if (!currentUser || !currentUser.is_admin) {
                showError('Admin access required');
                return;
            }
            
            const title = document.getElementById('alertTitle').value.trim();
            const message = document.getElementById('alertMessage').value.trim();
            const severity = document.getElementById('alertSeverity').value;
            const targetRanch = document.getElementById('targetRanch').value;
            
            if (!title || !message) {
                showError('Please provide both title and message for the alert');
                return;
            }
            
            try {
                const response = await fetch('/api/alerts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        message,
                        severity,
                        ranch_id: targetRanch === 'all' ? null : parseInt(targetRanch),
                        user_id: currentUser.id
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Fire alert sent successfully!');
                    
                    // Clear form
                    document.getElementById('alertTitle').value = '';
                    document.getElementById('alertMessage').value = '';
                    document.getElementById('alertSeverity').value = 'low';
                    document.getElementById('targetRanch').value = 'all';
                    
                    // Refresh alerts
                    loadAlerts();
                } else {
                    throw new Error(result.error || 'Failed to send alert');
                }
                
            } catch (error) {
                console.error('Error sending alert:', error);
                showError('Failed to send alert: ' + error.message);
            }
        }

        async function editAlert(alertId) {
            // Get current alert data
            try {
                const response = await fetch(`/api/alerts/${alertId}`);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to get alert data');
                }
                
                const alert = result.alert;
                
                // Create edit form
                const editForm = `
                    <div class="card" style="margin-top: 15px;">
                        <h4>Edit Alert</h4>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="editTitle" value="${alert.title}" />
                        </div>
                        <div class="form-group">
                            <label>Message</label>
                            <textarea id="editMessage" rows="3">${alert.message}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Severity</label>
                            <select id="editSeverity">
                                <option value="low" ${alert.severity === 'low' ? 'selected' : ''}>🟡 Low</option>
                                <option value="medium" ${alert.severity === 'medium' ? 'selected' : ''}>🟠 Medium</option>
                                <option value="high" ${alert.severity === 'high' ? 'selected' : ''}>🔴 High</option>
                                <option value="critical" ${alert.severity === 'critical' ? 'selected' : ''}>⚫ Critical</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="editStatus">
                                <option value="active" ${alert.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="resolved" ${alert.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="saveAlertEdit(${alertId})">Save Changes</button>
                            <button class="btn" onclick="cancelEdit()">Cancel</button>
                        </div>
                    </div>
                `;
                
                // Show edit form
                const alertElement = document.querySelector(`[data-alert-id="${alertId}"]`);
                if (alertElement) {
                    alertElement.insertAdjacentHTML('afterend', editForm);
                }
                
            } catch (error) {
                console.error('Error loading alert for edit:', error);
                showError('Failed to load alert data: ' + error.message);
            }
        }

        async function saveAlertEdit(alertId) {
            const title = document.getElementById('editTitle').value.trim();
            const message = document.getElementById('editMessage').value.trim();
            const severity = document.getElementById('editSeverity').value;
            const status = document.getElementById('editStatus').value;
            
            if (!title || !message) {
                showError('Title and message are required');
                return;
            }
            
            try {
                const response = await fetch(`/api/alerts/${alertId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        message,
                        severity,
                        status
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Alert updated successfully!');
                    cancelEdit();
                    loadAlerts();
                    if (currentUser && currentUser.is_admin) {
                        loadAdminAlerts();
                    }
                } else {
                    throw new Error(result.error || 'Failed to update alert');
                }
            } catch (error) {
                console.error('Error updating alert:', error);
                showError('Failed to update alert: ' + error.message);
            }
        }

        function cancelEdit() {
            const editForm = document.querySelector('.card h4');
            if (editForm && editForm.textContent === 'Edit Alert') {
                editForm.closest('.card').remove();
            }
        }

        // Admin alert management functions
        async function loadAdminAlerts() {
            if (!currentUser || !currentUser.is_admin) return;
            
            try {
                const response = await fetch(`/api/admin/alerts?user_id=${currentUser.id}`);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayAdminAlerts(result.alerts);
                } else {
                    throw new Error(result.error || 'Failed to load admin alerts');
                }
            } catch (error) {
                console.error('Error loading admin alerts:', error);
                document.getElementById('adminAlertsList').innerHTML = 
                    '<p style="color: #f44336;">Failed to load alerts: ' + error.message + '</p>';
            }
        }

        function displayAdminAlerts(alerts) {
            const alertsList = document.getElementById('adminAlertsList');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<p style="text-align: center; color: #666;">No alerts found</p>';
                return;
            }
            
            const tableHTML = `
                <table class="alert-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Severity</th>
                            <th>Status</th>
                            <th>Creator</th>
                            <th>Ranch</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${alerts.map(alert => `
                            <tr data-alert-id="${alert.id}">
                                <td>
                                    <div class="alert-details" title="${alert.title}">
                                        <strong>${alert.title}</strong>
                                    </div>
                                </td>
                                <td>
                                    <span class="severity-badge severity-${alert.severity}">
                                        ${alert.severity.toUpperCase()}
                                    </span>
                                </td>
                                <td>
                                    <span class="alert-status status-${alert.status}">
                                        ${alert.status}
                                    </span>
                                </td>
                                <td>${alert.creator_name}</td>
                                <td>${alert.ranch_name}</td>
                                <td>${new Date(alert.created_at).toLocaleDateString()}</td>
                                <td>
                                    <div class="alert-actions">
                                        <button class="btn btn-secondary" onclick="editAlert(${alert.id})" title="Edit Alert">
                                            ✏️ Edit
                                        </button>
                                        ${alert.status === 'active' ? 
                                            `<button class="btn btn-success" onclick="resolveAlert(${alert.id})" title="Resolve Alert">
                                                ✅ Resolve
                                            </button>` :
                                            `<button class="btn btn-secondary" onclick="reopenAlert(${alert.id})" title="Re-open Alert">
                                                🔄 Re-open
                                            </button>`
                                        }
                                        <button class="btn btn-danger" onclick="deleteAlert(${alert.id})" title="Delete Alert">
                                            🗑️ Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            alertsList.innerHTML = tableHTML;
        }

        function filterAdminAlerts() {
            const filter = document.getElementById('alertFilter').value;
            const rows = document.querySelectorAll('.alert-table tbody tr');
            
            rows.forEach(row => {
                const statusCell = row.querySelector('.alert-status');
                const status = statusCell ? statusCell.textContent.trim() : '';
                
                if (filter === 'all' || status === filter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        async function resolveAlert(alertId) {
            if (!confirm('Are you sure you want to resolve this alert?')) return;
            
            try {
                const response = await fetch(`/api/admin/alerts/${alertId}/resolve?user_id=${currentUser.id}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Alert resolved successfully!');
                    loadAdminAlerts();
                    loadAlerts(); // Refresh regular alerts view too
                } else {
                    throw new Error(result.error || 'Failed to resolve alert');
                }
            } catch (error) {
                console.error('Error resolving alert:', error);
                showError('Failed to resolve alert: ' + error.message);
            }
        }

        async function reopenAlert(alertId) {
            if (!confirm('Are you sure you want to re-open this alert?')) return;
            
            try {
                const response = await fetch(`/api/admin/alerts/${alertId}/reopen?user_id=${currentUser.id}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Alert reopened successfully!');
                    loadAdminAlerts();
                    loadAlerts(); // Refresh regular alerts view too
                } else {
                    throw new Error(result.error || 'Failed to reopen alert');
                }
            } catch (error) {
                console.error('Error reopening alert:', error);
                showError('Failed to reopen alert: ' + error.message);
            }
        }

        async function deleteAlert(alertId) {
            if (!confirm('Are you sure you want to delete this alert?')) return;
            
            try {
                const response = await fetch(`/api/alerts/${alertId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Alert deleted successfully!');
                    loadAlerts();
                    if (currentUser && currentUser.is_admin) {
                        loadAdminAlerts();
                    }
                } else {
                    throw new Error(result.error || 'Failed to delete alert');
                }
            } catch (error) {
                console.error('Error deleting alert:', error);
                showError('Failed to delete alert: ' + error.message);
            }
        }

        function logout() {
            currentUser = null;
            // Clear session from localStorage
            localStorage.removeItem('ranchFireAlertUser');
            
            // Clear PWA install dismissed preference so user sees prompt again on next login
            localStorage.removeItem('pwaInstallDismissed');
            
            // Hide user info in connection status pane
            const userInfoDiv = document.getElementById('userInfo');
            if (userInfoDiv) {
                userInfoDiv.style.display = 'none';
            }
            
            showSuccess('Logged out successfully');
            setTimeout(() => {
                showUserCheck();
            }, 1000);
        }

        // Handle online/offline events
        window.addEventListener('online', () => {
            checkConnection();
            showSuccess('Connection restored');
        });

        window.addEventListener('offline', () => {
            checkConnection();
            showError('Connection lost - app will work offline');
        });

        // Handle Enter key on forms
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const activeForm = document.querySelector('.card:not(.hidden)');
                if (activeForm) {
                    const button = activeForm.querySelector('.btn:not(.hidden)');
                    if (button && !button.disabled) {
                        button.click();
                    }
                }
            }
        });

        // Session validation
        async function validateSession() {
            if (!currentUser || !currentUser.id) {
                localStorage.removeItem('ranchFireAlertUser');
                showUserCheck();
                return;
            }
            
            try {
                // Try to load alerts to validate session
                const response = await fetch(`/api/alerts?user_id=${currentUser.id}`);
                
                if (response.ok) {
                    // Session is valid, show main app
                    showMainApp();
                } else {
                    // Session is invalid, clear and show login
                    localStorage.removeItem('ranchFireAlertUser');
                    currentUser = null;
                    showUserCheck();
                }
            } catch (error) {
                console.error('Session validation error:', error);
                // On network error, still show main app (offline mode)
                showMainApp();
            }
        }

        // Database management functions
        async function loadDatabaseStatus() {
            if (!currentUser || !currentUser.is_admin) return;
            
            try {
                const response = await fetch(`/api/admin/database/status?user_id=${currentUser.id}`);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayDatabaseStatus(result.database);
                } else {
                    throw new Error(result.error || 'Failed to load database status');
                }
            } catch (error) {
                console.error('Error loading database status:', error);
                document.getElementById('databaseStatus').innerHTML = 
                    '<p style="color: #f44336;">Failed to load database status: ' + error.message + '</p>';
            }
        }

        function displayDatabaseStatus(dbInfo) {
            const statusDiv = document.getElementById('databaseStatus');
            
            let backupsHtml = '';
            if (dbInfo.backups && dbInfo.backups.length > 0) {
                backupsHtml = `
                    <h4>Backups (${dbInfo.backups.length})</h4>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin: 10px 0;">
                        ${dbInfo.backups.map(backup => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #eee;">
                                <div>
                                    <strong>${backup.filename}</strong><br>
                                    <small>Size: ${(backup.size / 1024).toFixed(1)} KB</small>
                                </div>
                                <div style="text-align: right;">
                                    <small>${new Date(backup.modified).toLocaleString()}</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            statusDiv.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h4>Database Information</h4>
                    <p><strong>Type:</strong> ${dbInfo.type}</p>
                    <p><strong>Connection:</strong> ${dbInfo.uri}</p>
                    <p><strong>Tables:</strong> ${dbInfo.tables.length} tables</p>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        ${dbInfo.tables.map(table => `<li>${table}</li>`).join('')}
                    </ul>
                </div>
                ${backupsHtml}
            `;
        }

        async function createDatabaseBackup() {
            if (!currentUser || !currentUser.is_admin) return;
            
            if (!confirm('Create a database backup? This may take a moment.')) return;
            
            try {
                const response = await fetch(`/api/admin/database/backup?user_id=${currentUser.id}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Database backup created successfully!');
                    loadDatabaseStatus(); // Refresh status to show new backup
                } else {
                    throw new Error(result.error || 'Failed to create backup');
                }
            } catch (error) {
                console.error('Error creating database backup:', error);
                showError('Failed to create backup: ' + error.message);
            }
        }

        // --- User Management Functions ---
        async function loadUsers() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '<p>Loading users...</p>';
            try {
                const response = await fetch(`/api/admin/users?user_id=${currentUser.id}`);
                const result = await response.json();
                if (result.success) {
                    if (result.users.length === 0) {
                        usersList.innerHTML = '<p>No users found.</p>';
                        return;
                    }
                    let table = `<table class="alert-table"><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Ranch</th><th>Admin</th><th>Actions</th></tr></thead><tbody>`;
                    for (const user of result.users) {
                        table += `<tr>
                            <td>${user.name}</td>
                            <td>${user.email || ''}</td>
                            <td>${user.phone || ''}</td>
                            <td>${user.ranch_id || ''}</td>
                            <td>${user.is_admin ? 'Yes' : 'No'}</td>
                            <td>
                                <button class='btn btn-secondary' onclick='showEditUserModal(${user.id})'>Edit</button>
                                <button class='btn btn-danger' onclick='deleteUser(${user.id})'>Delete</button>
                            </td>
                        </tr>`;
                    }
                    table += '</tbody></table>';
                    usersList.innerHTML = table;
                } else {
                    usersList.innerHTML = `<p style='color:#B22222;'>${result.error || 'Failed to load users.'}</p>`;
                }
            } catch (error) {
                usersList.innerHTML = `<p style='color:#B22222;'>Error loading users: ${error.message}</p>`;
            }
        }

        // --- User Management Modal Logic ---
        let editingUserId = null;
        function showAddUserModal() {
            editingUserId = null;
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('userFormName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPhone').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userIsAdmin').checked = false;
            loadRanchOptions('userRanch');
            document.getElementById('userModal').classList.remove('hidden');
        }
        async function showEditUserModal(userId) {
            editingUserId = userId;
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userPassword').value = '';
            loadRanchOptions('userRanch');
            try {
                const response = await fetch(`/api/admin/users?user_id=${currentUser.id}`);
                const result = await response.json();
                if (result.success) {
                    const user = result.users.find(u => u.id === userId);
                    if (!user) return;
                    document.getElementById('userFormName').value = user.name || '';
                    document.getElementById('userEmail').value = user.email || '';
                    document.getElementById('userPhone').value = user.phone || '';
                    document.getElementById('userIsAdmin').checked = !!user.is_admin;
                    document.getElementById('userRanch').value = user.ranch_id || '';
                    document.getElementById('userModal').classList.remove('hidden');
                }
            } catch {}
        }
        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }
        async function saveUser() {
            const name = document.getElementById('userFormName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            const password = document.getElementById('userPassword').value;
            const ranch_id = document.getElementById('userRanch').value;
            const is_admin = document.getElementById('userIsAdmin').checked;
            
            // Debug logging
            console.log('Form values:');
            console.log('  name:', `"${name}"`, 'length:', name.length);
            console.log('  email:', `"${email}"`);
            console.log('  phone:', `"${phone}"`);
            console.log('  ranch_id:', `"${ranch_id}"`);
            console.log('  is_admin:', is_admin);
            
            // Better validation
            if (!name) {
                console.log('Validation failed: name is empty');
                alert('Name is required.');
                return;
            }
            if (!ranch_id || ranch_id === '') {
                console.log('Validation failed: ranch_id is empty');
                alert('Ranch selection is required.');
                return;
            }
            if (!email && !phone) {
                console.log('Validation failed: neither email nor phone provided');
                alert('Email or phone number is required.');
                return;
            }
            
            console.log('Validation passed, sending request...');
            
            const payload = { name, email, phone, password, ranch_id, is_admin };
            let url = '/api/admin/users', method = 'POST';
            if (editingUserId) {
                url = `/api/admin/users/${editingUserId}`;
                method = 'PUT';
            }
            try {
                const response = await fetch(url + `?user_id=${currentUser.id}`, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.success) {
                    closeUserModal();
                    loadUsers();
                } else {
                    alert(result.error || 'Failed to save user.');
                }
            } catch (error) {
                alert('Error saving user: ' + error.message);
            }
        }
        async function deleteUser(userId) {
            if (!confirm('Delete this user?')) return;
            try {
                const response = await fetch(`/api/admin/users/${userId}?user_id=${currentUser.id}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    loadUsers();
                } else {
                    alert(result.error || 'Failed to delete user.');
                }
            } catch (error) {
                alert('Error deleting user: ' + error.message);
            }
        }
        async function loadRanchOptions(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Loading...</option>';
            try {
                const response = await fetch('/api/ranches');
                const result = await response.json();
                if (result.success) {
                    select.innerHTML = '<option value="">Select Ranch</option>';
                    for (const ranch of result.ranches) {
                        select.innerHTML += `<option value="${ranch.id}">${ranch.name}</option>`;
                    }
                } else {
                    select.innerHTML = '<option value="">Failed to load ranches</option>';
                }
            } catch {
                select.innerHTML = '<option value="">Failed to load ranches</option>';
            }
        }

        window.showEditUserModal = showEditUserModal;
        window.showAddUserModal = showAddUserModal;
        window.deleteUser = deleteUser;
        window.closeUserModal = closeUserModal;

        // --- iOS/Safari Install Banner Logic ---
        function isIos() {
            return /iphone|ipad|ipod/i.test(navigator.userAgent);
        }
        function isInStandaloneMode() {
            return (window.navigator.standalone === true) || (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches);
        }
        function isSafari() {
            return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        }
        function maybeShowIosInstallBanner() {
            if (isIos() && isSafari() && !isInStandaloneMode()) {
                if (!localStorage.getItem('iosInstallBannerDismissed')) {
                    document.getElementById('iosInstallBanner').classList.remove('hidden');
                }
            }
        }
        function dismissIosBanner() {
            document.getElementById('iosInstallBanner').classList.add('hidden');
            localStorage.setItem('iosInstallBannerDismissed', '1');
        }
        document.addEventListener('DOMContentLoaded', maybeShowIosInstallBanner);

        // Check for new alerts periodically
        let lastAlertCount = 0;
        async function checkForNewAlerts() {
            if (!currentUser) {
                console.log('No current user, skipping alert check');
                return;
            }
            
            console.log('Checking for new alerts...');
            
            try {
                const response = await fetch(`/api/alerts?user_id=${currentUser.id}`);
                const result = await response.json();
                
                if (result.success) {
                    const activeAlerts = result.alerts.filter(alert => alert.status === 'active');
                    const currentAlertCount = activeAlerts.length;
                    
                    console.log(`Current alerts: ${currentAlertCount}, Last count: ${lastAlertCount}`);
                    
                    // If we have new alerts and the app is not focused, show notification
                    if (currentAlertCount > lastAlertCount && !document.hasFocus()) {
                        console.log(`New alerts detected! Showing ${currentAlertCount - lastAlertCount} notifications`);
                        const newAlerts = activeAlerts.slice(0, currentAlertCount - lastAlertCount);
                        
                        newAlerts.forEach(alert => {
                            showSystemNotification(alert);
                        });
                    }
                    
                    lastAlertCount = currentAlertCount;
                    
                    // Update badges even if we don't show notifications
                    updateDocumentBadge(currentAlertCount);
                }
            } catch (error) {
                console.error('Error checking for new alerts:', error);
            }
        }
        
        // Show system notification
        function showSystemNotification(alert) {
            console.log('Attempting to show system notification for alert:', alert);
            
            if (!('Notification' in window)) {
                console.log('Notifications not supported in this browser');
                return;
            }
            
            console.log('Notification permission:', Notification.permission);
            
            if (Notification.permission === 'default') {
                console.log('Requesting notification permission...');
                Notification.requestPermission().then(permission => {
                    console.log('Permission granted:', permission);
                    if (permission === 'granted') {
                        createNotification(alert);
                    }
                });
                return;
            }
            
            if (Notification.permission !== 'granted') {
                console.log('Notification permission denied');
                return;
            }
            
            createNotification(alert);
        }
        
        function createNotification(alert) {
            console.log('Creating notification for alert:', alert.title);
            
            const notification = new Notification(`🔥 ${alert.severity.toUpperCase()} Alert`, {
                body: alert.message,
                icon: '/static/icons/icon-192.png',
                badge: '/static/icons/icon-192.png',
                tag: `alert-${alert.id}`,
                requireInteraction: true,
                data: { alertId: alert.id }
            });
            
            notification.onclick = function() {
                console.log('Notification clicked, focusing window and showing alerts tab');
                window.focus();
                showTab('alerts');
                notification.close();
            };
            
            notification.onshow = function() {
                console.log('Notification shown successfully');
            };
            
            notification.onerror = function(error) {
                console.error('Notification error:', error);
            };
        }
    </script>
</body>
</html>