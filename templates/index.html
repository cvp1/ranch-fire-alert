<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMR Alert System</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#CD853F">
    <link rel="icon" href="/static/icons/icon-192.png">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- iOS Specific Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fire Alert">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <link rel="apple-touch-startup-image" href="/static/icons/icon-512.png">
    
    <meta name="description" content="Emergency fire notification system for ranch communities">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #FAF3E3, #F5DEB3);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1, .header p {
            color: #6B4423;
            text-shadow: 0 2px 8px rgba(250, 243, 227, 0.25);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .alert-card {
            border-left: 5px solid #d32f2f;
        }
        
        .alert-card.critical {
            border-left-color: #8B0000;
            background: #fff5f5;
        }
        
        .alert-card.high {
            border-left-color: #FF0000;
            background: #fff8f8;
        }
        
        .alert-card.medium {
            border-left-color: #FF4500;
        }
        
        .alert-card.low {
            border-left-color: #FFA500;
        }
        
        .severity-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .severity-critical {
            background: #8B0000;
            color: white;
        }
        
        .severity-high {
            background: #FF0000;
            color: white;
        }
        
        .severity-medium {
            background: #FF4500;
            color: white;
        }
        
        .severity-low {
            background: #FFA500;
            color: white;
        }
        
        .btn {
            background: #CD853F;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            font-weight: 500;
            transition: background 0.3s ease;
        }
        
        .btn:hover {
            background: #A0522D;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #8B7355;
        }
        
        .btn-secondary:hover {
            background: #6B4423;
        }
        
        .btn-success {
            background: #CD853F;
        }
        
        .btn-success:hover {
            background: #B8860B;
        }
        
        .btn-danger {
            background: #B22222;
        }
        
        .btn-danger:hover {
            background: #8B0000;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #CD853F;
            box-shadow: 0 0 0 2px rgba(205, 133, 63, 0.1);
        }
        
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online {
            background: #4caf50;
        }
        
        .status-offline {
            background: #f44336;
        }
        
        .livestock-request {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .hidden {
            display: none;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px 8px;
            text-align: center;
            background: #f5f5f5;
            cursor: pointer;
            border: none;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: #d32f2f;
            color: white;
        }
        
        .tab:hover {
            opacity: 0.8;
        }
        
        .timestamp {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c62828;
        }
        
        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }
        
        .info-message {
            background: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #1976d2;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-link {
            color: #1976d2;
            text-decoration: none;
            cursor: pointer;
        }
        
        .text-link:hover {
            text-decoration: underline;
        }
        
        .user-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .user-info h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #d32f2f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .install-prompt {
            background: #CD853F;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .admin-alert-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }
        
        .admin-alert-actions .btn {
            flex: 1;
            font-size: 12px;
            padding: 6px 12px;
            margin: 0;
        }
        
        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .admin-controls .btn {
            flex: 0 0 auto;
            margin: 0;
        }
        
        .admin-controls select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .alert-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .alert-table th,
        .alert-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .alert-table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }
        
        .alert-table tr:hover {
            background: #f9f9f9;
        }
        
        .alert-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-active {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status-resolved {
            background: #e8f5e8;
            color: #388e3c;
        }
        
        .alert-actions {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .alert-actions .btn {
            font-size: 11px;
            padding: 4px 8px;
            margin: 0;
            min-width: auto;
        }
        
        .alert-details {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .logout-section {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        
        .alert-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            display: block;
            font-size: 20px;
            font-weight: bold;
            color: #d32f2f;
        }
        
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
        .modal.hidden { display: none; }
        .modal-content { min-width: 320px; max-width: 95vw; position: relative; }
        .close { position: absolute; right: 18px; top: 12px; font-size: 28px; color: #B22222; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üî• DMR Fire Alert</h1>
            <p>Emergency Communication System</p>
        </div>

        <!-- Error/Success Messages -->
        <div id="errorDisplay" class="error-message hidden">
            <span id="errorMessage"></span>
        </div>
        
        <div id="successDisplay" class="success-message hidden">
            <span id="successMessage"></span>
        </div>

        <!-- Install Prompt (PWA) -->
        <div id="installPrompt" class="install-prompt hidden">
            <p><strong>üèúÔ∏è Add to Home Screen</strong></p>
            <p>Add to your home screen for quick access and offline use</p>
            <button class="btn btn-success" onclick="installPWA()">Install App</button>
        </div>

        <!-- Connection Status -->
        <div class="card">
            <p>
                <span id="connectionStatus" class="status-indicator status-offline"></span>
                <span id="connectionText">Checking connection...</span>
            </p>
        </div>

        <!-- User Check Form -->
        <div id="userCheckForm" class="card">
            <h2>Get Started</h2>
            <p style="margin-bottom: 15px;">Enter your email or phone number to continue:</p>
            
            <div class="form-group">
                <input type="text" id="userIdentifier" placeholder="Email or phone number" autocomplete="username">
            </div>
            
            <button class="btn" onclick="checkUser()" id="checkUserBtn">Continue</button>
            <div class="loading hidden" id="checkUserLoading"></div>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="card hidden">
            <h2>Welcome Back</h2>
            
            <div id="existingUserInfo" class="user-info"></div>
            
            <div class="form-group">
                <label for="loginPassword">Password (optional):</label>
                <input type="password" id="loginPassword" placeholder="Enter password or leave blank">
            </div>
            
            <button class="btn" onclick="login()" id="loginBtn">Sign In</button>
            <div class="loading hidden" id="loginLoading"></div>
            
            <div class="auth-toggle">
                <span class="text-link" onclick="showUserCheck()">‚Üê Back</span>
            </div>
        </div>

        <!-- Registration Form -->
        <div id="registrationForm" class="card hidden">
            <h2>Join the Alert System</h2>
            
            <div class="form-group">
                <label for="regName">Full Name *</label>
                <input type="text" id="regName" placeholder="Your full name" required>
            </div>
            
            <div class="form-group">
                <label for="regEmail">Email</label>
                <input type="email" id="regEmail" placeholder="your@email.com">
            </div>
            
            <div class="form-group">
                <label for="regPhone">Phone Number</label>
                <input type="tel" id="regPhone" placeholder="(555) 123-4567">
            </div>
            
            <div class="form-group">
                <label for="regPassword">Password (optional)</label>
                <input type="password" id="regPassword" placeholder="Create a password">
                <small style="color: #666;">Leave blank for passwordless access</small>
            </div>
            
            <div class="form-group">
                <label for="regRanch">Select Ranch *</label>
                <select id="regRanch" required>
                    <option value="">Choose your ranch...</option>
                </select>
            </div>
            
            <button class="btn" onclick="register()" id="registerBtn">Join Alert System</button>
            <div class="loading hidden" id="registerLoading"></div>
            
            <div class="auth-toggle">
                <span class="text-link" onclick="showUserCheck()">‚Üê Back</span>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainApp" class="hidden">
            <!-- User Info -->
            <div class="card">
                <div class="user-info">
                    <h3 id="userName"></h3>
                    <p id="userDetails"></p>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('alerts')">üî• Alerts</button>
                <button class="tab" onclick="showTab('livestock')">üêÑ Livestock</button>
                <button class="tab" onclick="showTab('admin')" id="adminTabBtn" style="display:none;">‚öôÔ∏è Admin</button>
                <button class="tab" onclick="showTab('users')" id="usersTabBtn" style="display:none;">üë§ Users</button>
            </div>

            <!-- Alerts Tab -->
            <div id="alertsTab">
                <div class="card">
                    <div class="alert-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="totalAlerts">0</span>
                            <span>Total Alerts</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="activeAlerts">0</span>
                            <span>Active</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="criticalAlerts">0</span>
                            <span>Critical</span>
                        </div>
                    </div>
                    <button class="btn" onclick="loadAlerts()">üîÑ Refresh Alerts</button>
                </div>
                
                <div id="alertsList"></div>
            </div>

            <!-- Livestock Tab -->
            <div id="livestockTab" class="hidden">
                <div class="card">
                    <h3>üêÑ Request Livestock Help</h3>
                    
                    <div class="form-group">
                        <label for="animalType">Animal Type</label>
                        <select id="animalType">
                            <option value="cattle">Cattle</option>
                            <option value="horses">Horses</option>
                            <option value="sheep">Sheep</option>
                            <option value="goats">Goats</option>
                            <option value="pigs">Pigs</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="animalCount">Number of Animals</label>
                        <input type="number" id="animalCount" min="1" placeholder="e.g. 25">
                    </div>
                    
                    <div class="form-group">
                        <label for="urgencyLevel">Urgency Level</label>
                        <select id="urgencyLevel">
                            <option value="low">Low - Planning ahead</option>
                            <option value="medium">Medium - Need help today</option>
                            <option value="high">High - Need help now</option>
                            <option value="critical">Critical - Emergency</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="helpDetails">Details</label>
                        <textarea id="helpDetails" placeholder="Describe what help you need (transportation, temporary housing, etc.)"></textarea>
                    </div>
                    
                    <button class="btn" onclick="requestLivestockHelp()">Request Help</button>
                </div>
                
                <div id="livestockRequestsList"></div>
            </div>

            <!-- Admin Tab -->
            <div id="adminTab" class="hidden">
                <div class="card">
                    <h3>üö® Send Fire Alert</h3>
                    
                    <div class="form-group">
                        <label for="alertTitle">Alert Title</label>
                        <input type="text" id="alertTitle" placeholder="e.g. Wildfire Alert - Highway 89">
                    </div>
                    
                    <div class="form-group">
                        <label for="alertMessage">Alert Message</label>
                        <textarea id="alertMessage" placeholder="Provide detailed information about the fire alert..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="alertSeverity">Severity Level</label>
                        <select id="alertSeverity">
                            <option value="low">üü° Low - Informational</option>
                            <option value="medium">üü† Medium - Caution advised</option>
                            <option value="high">üî¥ High - Immediate action recommended</option>
                            <option value="critical">‚ö´ Critical - Emergency evacuation</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="targetRanch">Target Ranch</label>
                        <select id="targetRanch">
                            <option value="all">All Ranches</option>
                        </select>
                    </div>
                    
                    <button class="btn" onclick="sendAlert()">Send Fire Alert</button>
                </div>
                
                <div class="card">
                    <h3>üìä System Statistics</h3>
                    <div id="adminStats">
                        <p>Loading statistics...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üîß Alert Management</h3>
                    <div class="admin-controls">
                        <button class="btn btn-secondary" onclick="loadAdminAlerts()">Refresh Alerts</button>
                        <select id="alertFilter" onchange="filterAdminAlerts()">
                            <option value="all">All Alerts</option>
                            <option value="active">Active Only</option>
                            <option value="resolved">Resolved Only</option>
                        </select>
                    </div>
                    <div id="adminAlertsList">
                        <p>Click "Refresh Alerts" to load alert management data...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üóÑÔ∏è Database Management</h3>
                    <div class="admin-controls">
                        <button class="btn btn-secondary" onclick="loadDatabaseStatus()">Database Status</button>
                        <button class="btn btn-success" onclick="createDatabaseBackup()">Create Backup</button>
                    </div>
                    <div id="databaseStatus">
                        <p>Click "Database Status" to view database information...</p>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="hidden">
                <div class="card">
                    <h3>üë§ User Management</h3>
                    <div id="usersList">
                        <p>Loading users...</p>
                    </div>
                    <button class="btn btn-success" onclick="showAddUserModal()">Add User</button>
                </div>
            </div>

            <!-- Logout -->
            <div class="logout-section">
                <button class="btn btn-secondary" onclick="logout()">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal hidden">
        <div class="modal-content card">
            <span class="close" onclick="closeUserModal()">&times;</span>
            <h3 id="userModalTitle">Add User</h3>
            <div class="form-group">
                <label for="userName">Full Name *</label>
                <input type="text" id="userName" required>
            </div>
            <div class="form-group">
                <label for="userEmail">Email</label>
                <input type="email" id="userEmail">
            </div>
            <div class="form-group">
                <label for="userPhone">Phone</label>
                <input type="tel" id="userPhone">
            </div>
            <div class="form-group">
                <label for="userPassword">Password</label>
                <input type="password" id="userPassword" placeholder="Leave blank to keep unchanged">
            </div>
            <div class="form-group">
                <label for="userRanch">Ranch *</label>
                <select id="userRanch"></select>
            </div>
            <div class="form-group">
                <label for="userIsAdmin"><input type="checkbox" id="userIsAdmin"> Admin</label>
            </div>
            <button class="btn btn-success" id="userModalSaveBtn" onclick="saveUser()">Save</button>
        </div>
    </div>

    <!-- Firebase SDK v9 (modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging.js';
        
        // Make Firebase available globally
        window.firebaseApp = null;
        window.firebaseMessaging = null;
        window.initializeFirebaseApp = function(config) {
            try {
                window.firebaseApp = initializeApp(config.firebase);
                window.firebaseMessaging = getMessaging(window.firebaseApp);
                console.log('Firebase initialized successfully');
                return true;
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                return false;
            }
        };
        
        window.getFirebaseToken = async function(vapidKey) {
            if (!window.firebaseMessaging) return null;
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const token = await getToken(window.firebaseMessaging, { vapidKey });
                    console.log('FCM Token:', token);
                    return token;
                } else {
                    console.log('Notification permission denied');
                    return null;
                }
            } catch (error) {
                console.error('Error getting Firebase token:', error);
                return null;
            }
        };
        
        window.setupFirebaseMessaging = function(onMessageCallback) {
            if (!window.firebaseMessaging) return;
            
            onMessage(window.firebaseMessaging, (payload) => {
                console.log('Message received in foreground:', payload);
                if (onMessageCallback) {
                    onMessageCallback(payload);
                }
            });
        };
    </script>

    <script>
        // Global variables
        let currentUser = null;
        let deferredPrompt = null;
        let swRegistration = null;

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkConnection();
            setupPWA();
            loadConfig();
            
            // Check for existing session
            const savedUser = localStorage.getItem('ranchFireAlertUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    // Validate session with server
                    validateSession();
                } catch (error) {
                    console.error('Error loading saved session:', error);
                    localStorage.removeItem('ranchFireAlertUser');
                    showUserCheck();
                }
            } else {
                showUserCheck();
            }
            
            // Set up periodic tasks
            setInterval(checkConnection, 10000);
        });

        // Load configuration from backend
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                if (config.firebase && config.firebase.apiKey !== 'demo-api-key') {
                    initializeFirebase(config);
                } else {
                    console.log('Firebase configuration not available - PWA features limited');
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Initialize Firebase
        function initializeFirebase(config) {
            try {
                if (window.initializeFirebaseApp && window.initializeFirebaseApp(config)) {
                    
                    if ('serviceWorker' in navigator) {
                        // Register both service workers
                        Promise.all([
                            navigator.serviceWorker.register('/static/sw.js'),
                            navigator.serviceWorker.register('/firebase-messaging-sw.js')
                        ]).then(([swReg, firebaseReg]) => {
                            swRegistration = swReg;
                            console.log('Service Workers registered successfully');
                            setupMessaging(config.vapidKey);
                        }).catch(error => {
                            console.error('Service Worker registration failed:', error);
                            // Continue without service workers
                            setupMessaging(config.vapidKey);
                        });
                    } else {
                        setupMessaging(config.vapidKey);
                    }
                } else {
                    console.log('Firebase initialization failed');
                }
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }
        }

        // Set up Firebase messaging
        function setupMessaging(vapidKey) {
            if (!window.firebaseMessaging || !window.setupFirebaseMessaging) return;
            
            // Handle foreground messages
            window.setupFirebaseMessaging((payload) => {
                const notificationTitle = payload.notification?.title || 'Fire Alert';
                const notificationOptions = {
                    body: payload.notification?.body || 'New alert received',
                    icon: '/static/icons/icon-192.png',
                    badge: '/static/icons/icon-72.png',
                    tag: 'fire-alert',
                    requireInteraction: true
                };
                
                if (swRegistration) {
                    swRegistration.showNotification(notificationTitle, notificationOptions);
                }
                
                // Refresh alerts if we're on the alerts tab
                if (!document.getElementById('alertsTab').classList.contains('hidden')) {
                    loadAlerts();
                }
            });
        }

        // Request notification permission and get token
        async function requestNotificationPermission() {
            if (!window.getFirebaseToken) {
                console.log('Firebase not available - skipping notification setup');
                return null;
            }
            
            try {
                // Load config to get VAPID key
                const response = await fetch('/api/config');
                const config = await response.json();
                
                if (config.vapidKey && config.vapidKey !== 'demo-vapid-key') {
                    return await window.getFirebaseToken(config.vapidKey);
                } else {
                    console.log('VAPID key not configured - skipping notifications');
                    return null;
                }
            } catch (error) {
                console.error('Error setting up notifications:', error);
                return null;
            }
        }

        // PWA Installation
        function setupPWA() {
            // Listen for beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install prompt
                const installPrompt = document.getElementById('installPrompt');
                if (installPrompt) {
                    installPrompt.classList.remove('hidden');
                }
            });
            
            // Handle app installed event
            window.addEventListener('appinstalled', (e) => {
                console.log('PWA was installed');
                const installPrompt = document.getElementById('installPrompt');
                if (installPrompt) {
                    installPrompt.classList.add('hidden');
                }
            });
        }

        // Install PWA
        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                }
                
                deferredPrompt = null;
                document.getElementById('installPrompt').classList.add('hidden');
            }
        }

        // Connection status check
        function checkConnection() {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('connectionText');
            
            if (navigator.onLine) {
                indicator.className = 'status-indicator status-online';
                text.textContent = 'Connected';
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = 'Offline';
            }
        }

        // Utility functions
        function hideAllForms() {
            const forms = ['userCheckForm', 'loginForm', 'registrationForm', 'mainApp'];
            forms.forEach(form => {
                document.getElementById(form).classList.add('hidden');
            });
        }

        function showError(message) {
            const errorDisplay = document.getElementById('errorDisplay');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorDisplay.classList.remove('hidden');
            
            // Hide success message
            document.getElementById('successDisplay').classList.add('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorDisplay.classList.add('hidden');
            }, 5000);
        }

        function showSuccess(message) {
            const successDisplay = document.getElementById('successDisplay');
            const successMessage = document.getElementById('successMessage');
            
            successMessage.textContent = message;
            successDisplay.classList.remove('hidden');
            
            // Hide error message
            document.getElementById('errorDisplay').classList.add('hidden');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                successDisplay.classList.add('hidden');
            }, 3000);
        }

        function setLoading(elementId, isLoading) {
            const btn = document.getElementById(elementId);
            const loading = document.getElementById(elementId.replace('Btn', 'Loading'));
            
            if (isLoading) {
                btn.classList.add('hidden');
                loading.classList.remove('hidden');
            } else {
                btn.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        }

        // Authentication functions
        function showUserCheck() {
            hideAllForms();
            document.getElementById('userCheckForm').classList.remove('hidden');
            document.getElementById('userIdentifier').value = '';
            document.getElementById('userIdentifier').focus();
        }

        async function checkUser() {
            const identifier = document.getElementById('userIdentifier').value.trim();
            
            if (!identifier) {
                showError('Please enter your email or phone number');
                return;
            }
            
            setLoading('checkUserBtn', true);
            
            try {
                const response = await fetch('/api/check-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.exists) {
                        showLogin(result.user);
                    } else {
                        showRegistration(identifier);
                    }
                } else {
                    throw new Error(result.error || 'User check failed');
                }
                
            } catch (error) {
                console.error('Check user error:', error);
                showError('Error checking user: ' + error.message);
            } finally {
                setLoading('checkUserBtn', false);
            }
        }

        function showLogin(userData) {
            hideAllForms();
            
            const loginForm = document.getElementById('loginForm');
            const userInfo = document.getElementById('existingUserInfo');
            
            userInfo.innerHTML = `
                <h4>${userData.name}</h4>
                <p style="margin: 5px 0; color: #666;">${userData.email || userData.phone}</p>
                <p style="margin: 5px 0; color: #666;">${userData.ranch_name}</p>
            `;
            
            loginForm.classList.remove('hidden');
            document.getElementById('loginPassword').focus();
        }

        async function login() {
            const identifier = currentUser?.email || currentUser?.phone || document.getElementById('userIdentifier').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            setLoading('loginBtn', true);
            
            try {
                // Get FCM token for notifications
                const fcmToken = await requestNotificationPermission();
                
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        identifier, 
                        password,
                        fcm_token: fcmToken
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.user;
                    // Save user session to localStorage
                    localStorage.setItem('ranchFireAlertUser', JSON.stringify(currentUser));
                    showSuccess('Login successful!');
                    showMainApp();
                } else {
                    throw new Error(result.error || 'Login failed');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed: ' + error.message);
            } finally {
                setLoading('loginBtn', false);
            }
        }

        function showRegistration(identifier = '') {
            hideAllForms();
            loadRanches();
            
            const registrationForm = document.getElementById('registrationForm');
            
            // Pre-fill identifier if provided
            if (identifier) {
                if (identifier.includes('@')) {
                    document.getElementById('regEmail').value = identifier;
                } else {
                    document.getElementById('regPhone').value = identifier;
                }
            }
            
            registrationForm.classList.remove('hidden');
            document.getElementById('regName').focus();
        }

        async function loadRanches() {
            try {
                const response = await fetch('/api/ranches');
                const result = await response.json();
                
                if (result.success) {
                    const ranchSelect = document.getElementById('regRanch');
                    const targetRanchSelect = document.getElementById('targetRanch');
                    
                    // Clear existing options (except first)
                    ranchSelect.innerHTML = '<option value="">Choose your ranch...</option>';
                    if (targetRanchSelect) {
                        targetRanchSelect.innerHTML = '<option value="all">All Ranches</option>';
                    }
                    
                    result.ranches.forEach(ranch => {
                        const option = document.createElement('option');
                        option.value = ranch.id;
                        option.textContent = ranch.name;
                        ranchSelect.appendChild(option);
                        
                        if (targetRanchSelect) {
                            const targetOption = document.createElement('option');
                            targetOption.value = ranch.id;
                            targetOption.textContent = ranch.name;
                            targetRanchSelect.appendChild(targetOption);
                        }
                    });
                } else {
                    console.error('Failed to load ranches:', result.error);
                }
            } catch (error) {
                console.error('Error loading ranches:', error);
            }
        }

        async function register() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const password = document.getElementById('regPassword').value;
            const ranchId = document.getElementById('regRanch').value;
            
            // Validation
            if (!name) {
                showError('Please enter your full name');
                return;
            }
            
            if (!email && !phone) {
                showError('Please enter either an email or phone number');
                return;
            }
            
            if (!ranchId) {
                showError('Please select your ranch');
                return;
            }
            
            setLoading('registerBtn', true);
            
            try {
                // Get FCM token for notifications
                const fcmToken = await requestNotificationPermission();
                
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        email: email || null,
                        phone: phone || null,
                        password: password || null,
                        ranch_id: parseInt(ranchId),
                        fcm_token: fcmToken
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.user;
                    // Save user session to localStorage
                    localStorage.setItem('ranchFireAlertUser', JSON.stringify(currentUser));
                    showSuccess('Registration successful! Welcome to the alert system.');
                    showMainApp();
                } else {
                    throw new Error(result.error || 'Registration failed');
                }
                
            } catch (error) {
                console.error('Registration error:', error);
                showError('Registration failed: ' + error.message);
            } finally {
                setLoading('registerBtn', false);
            }
        }

        // Main application functions
        function showMainApp() {
            hideAllForms();
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update user info
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userDetails').textContent = 
                    `${currentUser.email || currentUser.phone} ‚Ä¢ ${currentUser.ranch_name}`;
                
                // Show admin tab if user is admin
                if (currentUser.is_admin) {
                    document.getElementById('adminTabBtn').style.display = 'block';
                    document.getElementById('usersTabBtn').style.display = 'block';
                }
            }
            
            loadAlerts();
            loadLivestockRequests();
            
            // Set up periodic refresh
            setInterval(() => {
                if (!document.getElementById('mainApp').classList.contains('hidden')) {
                    loadAlerts();
                    loadLivestockRequests();
                }
            }, 30000);
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.getElementById('alertsTab').classList.add('hidden');
            document.getElementById('livestockTab').classList.add('hidden');
            document.getElementById('adminTab').classList.add('hidden');
            document.getElementById('usersTab').classList.add('hidden');
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            if (tabName === 'livestock') {
                loadLivestockRequests();
            } else if (tabName === 'admin') {
                loadAdminStats();
            } else if (tabName === 'users') {
                loadUsers();
            }
        }

        // Alerts functions
        async function loadAlerts() {
            try {
                const url = currentUser ? `/api/alerts?user_id=${currentUser.id}` : '/api/alerts';
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayAlerts(result.alerts);
                    updateAlertStats(result.alerts);
                } else {
                    throw new Error(result.error || 'Failed to load alerts');
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
                showError('Failed to load alerts: ' + error.message);
            }
        }

        function displayAlerts(alerts) {
            const alertsList = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = `
                    <div class="card">
                        <p style="text-align: center; color: #666;">No fire alerts at this time</p>
                    </div>
                `;
                return;
            }
            
            alertsList.innerHTML = alerts.map(alert => `
                <div class="card alert-card ${alert.severity}" data-alert-id="${alert.id}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div class="severity-badge severity-${alert.severity}">
                            ${alert.severity.toUpperCase()}
                        </div>
                        <span class="alert-status status-${alert.status}">
                            ${alert.status}
                        </span>
                    </div>
                    <h3>${alert.title}</h3>
                    <p style="margin: 10px 0;">${alert.message}</p>
                    <div class="timestamp">
                        ${new Date(alert.created_at).toLocaleString()}
                    </div>
                    ${currentUser && currentUser.is_admin ? `
                        <div class="admin-alert-actions">
                            <button class="btn btn-secondary" onclick="editAlert(${alert.id})">‚úèÔ∏è Edit</button>
                            ${alert.status === 'active' ? 
                                `<button class="btn btn-success" onclick="resolveAlert(${alert.id})">‚úÖ Resolve</button>` :
                                `<button class="btn btn-secondary" onclick="reopenAlert(${alert.id})">üîÑ Re-open</button>`
                            }
                            <button class="btn btn-danger" onclick="deleteAlert(${alert.id})">üóëÔ∏è Delete</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function updateAlertStats(alerts) {
            const totalAlerts = alerts.length;
            const activeAlerts = alerts.filter(alert => alert.status === 'active').length;
            const resolvedAlerts = alerts.filter(alert => alert.status === 'resolved').length;
            const criticalAlerts = alerts.filter(alert => alert.severity === 'critical').length;
            
            document.getElementById('totalAlerts').textContent = totalAlerts;
            document.getElementById('activeAlerts').textContent = activeAlerts;
            document.getElementById('criticalAlerts').textContent = criticalAlerts;
        }

        // Livestock functions
        async function loadLivestockRequests() {
            try {
                const url = currentUser ? `/api/livestock-requests?user_id=${currentUser.id}` : '/api/livestock-requests';
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayLivestockRequests(result.requests);
                } else {
                    throw new Error(result.error || 'Failed to load livestock requests');
                }
            } catch (error) {
                console.error('Error loading livestock requests:', error);
                showError('Failed to load livestock requests: ' + error.message);
            }
        }

        function displayLivestockRequests(requests) {
            const requestsList = document.getElementById('livestockRequestsList');
            
            if (requests.length === 0) {
                requestsList.innerHTML = `
                    <div class="card">
                        <p style="text-align: center; color: #666;">No livestock help requests</p>
                    </div>
                `;
                return;
            }
            
            requestsList.innerHTML = requests.map(request => `
                <div class="livestock-request">
                    <h4>${request.user_name} - ${request.animal_type} (${request.animal_count})</h4>
                    <p><strong>Urgency:</strong> ${request.urgency_level.toUpperCase()}</p>
                    <p>${request.details}</p>
                    <div class="timestamp">
                        Requested: ${new Date(request.created_at).toLocaleString()}
                    </div>
                    ${request.user_id !== currentUser?.id ? `
                        <button class="btn btn-success" onclick="offerHelp(${request.id})">
                            Offer Help
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        async function requestLivestockHelp() {
            const animalType = document.getElementById('animalType').value;
            const animalCount = document.getElementById('animalCount').value;
            const urgencyLevel = document.getElementById('urgencyLevel').value;
            const details = document.getElementById('helpDetails').value.trim();
            
            if (!animalCount || animalCount <= 0) {
                showError('Please enter a valid number of animals');
                return;
            }
            
            if (!details) {
                showError('Please provide details about the help needed');
                return;
            }
            
            try {
                const response = await fetch('/api/livestock-requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        animal_type: animalType,
                        animal_count: parseInt(animalCount),
                        urgency_level: urgencyLevel,
                        details
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Livestock help request submitted successfully!');
                    
                    // Clear form
                    document.getElementById('animalCount').value = '';
                    document.getElementById('helpDetails').value = '';
                    
                    // Reload requests
                    loadLivestockRequests();
                } else {
                    throw new Error(result.error || 'Failed to submit request');
                }
                
            } catch (error) {
                console.error('Error submitting livestock request:', error);
                showError('Failed to submit request: ' + error.message);
            }
        }

        async function offerHelp(requestId) {
            try {
                const response = await fetch(`/api/livestock-requests/${requestId}/help`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.id })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message || 'Help offer sent! The requester will be notified.');
                } else {
                    throw new Error(result.error || 'Failed to offer help');
                }
                
            } catch (error) {
                console.error('Error offering help:', error);
                showError('Failed to offer help: ' + error.message);
            }
        }

        // Admin functions
        async function loadAdminStats() {
            if (!currentUser || !currentUser.is_admin) return;
            
            try {
                const response = await fetch(`/api/admin/stats?user_id=${currentUser.id}`);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.stats;
                    document.getElementById('adminStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #d32f2f;">${stats.total_users}</div>
                                <div style="font-size: 12px; color: #666;">Total Users</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #d32f2f;">${stats.total_alerts}</div>
                                <div style="font-size: 12px; color: #666;">Total Alerts</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #1976d2;">${stats.active_alerts}</div>
                                <div style="font-size: 12px; color: #666;">Active Alerts</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: #388e3c;">${stats.resolved_alerts}</div>
                                <div style="font-size: 12px; color: #666;">Resolved Alerts</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #ff9800;">${stats.livestock_requests}</div>
                                <div style="font-size: 12px; color: #666;">Help Requests</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #4caf50;">${stats.active_ranches}</div>
                                <div style="font-size: 12px; color: #666;">Active Ranches</div>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(result.error || 'Failed to load admin stats');
                }
            } catch (error) {
                console.error('Error loading admin stats:', error);
                document.getElementById('adminStats').innerHTML = '<p style="color: #f44336;">Failed to load statistics</p>';
            }
        }

        async function sendAlert() {
            if (!currentUser || !currentUser.is_admin) {
                showError('Admin access required');
                return;
            }
            
            const title = document.getElementById('alertTitle').value.trim();
            const message = document.getElementById('alertMessage').value.trim();
            const severity = document.getElementById('alertSeverity').value;
            const targetRanch = document.getElementById('targetRanch').value;
            
            if (!title || !message) {
                showError('Please provide both title and message for the alert');
                return;
            }
            
            try {
                const response = await fetch('/api/alerts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        message,
                        severity,
                        ranch_id: targetRanch === 'all' ? null : parseInt(targetRanch),
                        user_id: currentUser.id
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Fire alert sent successfully!');
                    
                    // Clear form
                    document.getElementById('alertTitle').value = '';
                    document.getElementById('alertMessage').value = '';
                    document.getElementById('alertSeverity').value = 'low';
                    document.getElementById('targetRanch').value = 'all';
                    
                    // Refresh alerts
                    loadAlerts();
                } else {
                    throw new Error(result.error || 'Failed to send alert');
                }
                
            } catch (error) {
                console.error('Error sending alert:', error);
                showError('Failed to send alert: ' + error.message);
            }
        }

        async function editAlert(alertId) {
            // Get current alert data
            try {
                const response = await fetch(`/api/alerts/${alertId}`);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to get alert data');
                }
                
                const alert = result.alert;
                
                // Create edit form
                const editForm = `
                    <div class="card" style="margin-top: 15px;">
                        <h4>Edit Alert</h4>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="editTitle" value="${alert.title}" />
                        </div>
                        <div class="form-group">
                            <label>Message</label>
                            <textarea id="editMessage" rows="3">${alert.message}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Severity</label>
                            <select id="editSeverity">
                                <option value="low" ${alert.severity === 'low' ? 'selected' : ''}>üü° Low</option>
                                <option value="medium" ${alert.severity === 'medium' ? 'selected' : ''}>üü† Medium</option>
                                <option value="high" ${alert.severity === 'high' ? 'selected' : ''}>üî¥ High</option>
                                <option value="critical" ${alert.severity === 'critical' ? 'selected' : ''}>‚ö´ Critical</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="editStatus">
                                <option value="active" ${alert.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="resolved" ${alert.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="saveAlertEdit(${alertId})">Save Changes</button>
                            <button class="btn" onclick="cancelEdit()">Cancel</button>
                        </div>
                    </div>
                `;
                
                // Show edit form
                const alertElement = document.querySelector(`[data-alert-id="${alertId}"]`);
                if (alertElement) {
                    alertElement.insertAdjacentHTML('afterend', editForm);
                }
                
            } catch (error) {
                console.error('Error loading alert for edit:', error);
                showError('Failed to load alert data: ' + error.message);
            }
        }

        async function saveAlertEdit(alertId) {
            const title = document.getElementById('editTitle').value.trim();
            const message = document.getElementById('editMessage').value.trim();
            const severity = document.getElementById('editSeverity').value;
            const status = document.getElementById('editStatus').value;
            
            if (!title || !message) {
                showError('Title and message are required');
                return;
            }
            
            try {
                const response = await fetch(`/api/alerts/${alertId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        message,
                        severity,
                        status
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Alert updated successfully!');
                    cancelEdit();
                    loadAlerts();
                    if (currentUser && currentUser.is_admin) {
                        loadAdminAlerts();
                    }
                } else {
                    throw new Error(result.error || 'Failed to update alert');
                }
            } catch (error) {
                console.error('Error updating alert:', error);
                showError('Failed to update alert: ' + error.message);
            }
        }

        function cancelEdit() {
            const editForm = document.querySelector('.card h4');
            if (editForm && editForm.textContent === 'Edit Alert') {
                editForm.closest('.card').remove();
            }
        }

        // Admin alert management functions
        async function loadAdminAlerts() {
            if (!currentUser || !currentUser.is_admin) return;
            
            try {
                const response = await fetch(`/api/admin/alerts?user_id=${currentUser.id}`);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayAdminAlerts(result.alerts);
                } else {
                    throw new Error(result.error || 'Failed to load admin alerts');
                }
            } catch (error) {
                console.error('Error loading admin alerts:', error);
                document.getElementById('adminAlertsList').innerHTML = 
                    '<p style="color: #f44336;">Failed to load alerts: ' + error.message + '</p>';
            }
        }

        function displayAdminAlerts(alerts) {
            const alertsList = document.getElementById('adminAlertsList');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<p style="text-align: center; color: #666;">No alerts found</p>';
                return;
            }
            
            const tableHTML = `
                <table class="alert-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Severity</th>
                            <th>Status</th>
                            <th>Creator</th>
                            <th>Ranch</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${alerts.map(alert => `
                            <tr data-alert-id="${alert.id}">
                                <td>
                                    <div class="alert-details" title="${alert.title}">
                                        <strong>${alert.title}</strong>
                                    </div>
                                </td>
                                <td>
                                    <span class="severity-badge severity-${alert.severity}">
                                        ${alert.severity.toUpperCase()}
                                    </span>
                                </td>
                                <td>
                                    <span class="alert-status status-${alert.status}">
                                        ${alert.status}
                                    </span>
                                </td>
                                <td>${alert.creator_name}</td>
                                <td>${alert.ranch_name}</td>
                                <td>${new Date(alert.created_at).toLocaleDateString()}</td>
                                <td>
                                    <div class="alert-actions">
                                        <button class="btn btn-secondary" onclick="editAlert(${alert.id})" title="Edit Alert">
                                            ‚úèÔ∏è Edit
                                        </button>
                                        ${alert.status === 'active' ? 
                                            `<button class="btn btn-success" onclick="resolveAlert(${alert.id})" title="Resolve Alert">
                                                ‚úÖ Resolve
                                            </button>` :
                                            `<button class="btn btn-secondary" onclick="reopenAlert(${alert.id})" title="Re-open Alert">
                                                üîÑ Re-open
                                            </button>`
                                        }
                                        <button class="btn btn-danger" onclick="deleteAlert(${alert.id})" title="Delete Alert">
                                            üóëÔ∏è Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            alertsList.innerHTML = tableHTML;
        }

        function filterAdminAlerts() {
            const filter = document.getElementById('alertFilter').value;
            const rows = document.querySelectorAll('.alert-table tbody tr');
            
            rows.forEach(row => {
                const statusCell = row.querySelector('.alert-status');
                const status = statusCell ? statusCell.textContent.trim() : '';
                
                if (filter === 'all' || status === filter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        async function resolveAlert(alertId) {
            if (!confirm('Are you sure you want to resolve this alert?')) return;
            
            try {
                const response = await fetch(`/api/admin/alerts/${alertId}/resolve?user_id=${currentUser.id}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Alert resolved successfully!');
                    loadAdminAlerts();
                    loadAlerts(); // Refresh regular alerts view too
                } else {
                    throw new Error(result.error || 'Failed to resolve alert');
                }
            } catch (error) {
                console.error('Error resolving alert:', error);
                showError('Failed to resolve alert: ' + error.message);
            }
        }

        async function reopenAlert(alertId) {
            if (!confirm('Are you sure you want to re-open this alert?')) return;
            
            try {
                const response = await fetch(`/api/admin/alerts/${alertId}/reopen?user_id=${currentUser.id}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Alert reopened successfully!');
                    loadAdminAlerts();
                    loadAlerts(); // Refresh regular alerts view too
                } else {
                    throw new Error(result.error || 'Failed to reopen alert');
                }
            } catch (error) {
                console.error('Error reopening alert:', error);
                showError('Failed to reopen alert: ' + error.message);
            }
        }

        async function deleteAlert(alertId) {
            if (!confirm('Are you sure you want to delete this alert?')) return;
            
            try {
                const response = await fetch(`/api/alerts/${alertId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Alert deleted successfully!');
                    loadAlerts();
                    if (currentUser && currentUser.is_admin) {
                        loadAdminAlerts();
                    }
                } else {
                    throw new Error(result.error || 'Failed to delete alert');
                }
            } catch (error) {
                console.error('Error deleting alert:', error);
                showError('Failed to delete alert: ' + error.message);
            }
        }

        function logout() {
            currentUser = null;
            // Clear session from localStorage
            localStorage.removeItem('ranchFireAlertUser');
            showSuccess('Logged out successfully');
            setTimeout(() => {
                showUserCheck();
            }, 1000);
        }

        // Handle online/offline events
        window.addEventListener('online', () => {
            checkConnection();
            showSuccess('Connection restored');
        });

        window.addEventListener('offline', () => {
            checkConnection();
            showError('Connection lost - app will work offline');
        });

        // Handle Enter key on forms
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const activeForm = document.querySelector('.card:not(.hidden)');
                if (activeForm) {
                    const button = activeForm.querySelector('.btn:not(.hidden)');
                    if (button && !button.disabled) {
                        button.click();
                    }
                }
            }
        });

        // Session validation
        async function validateSession() {
            if (!currentUser || !currentUser.id) {
                localStorage.removeItem('ranchFireAlertUser');
                showUserCheck();
                return;
            }
            
            try {
                // Try to load alerts to validate session
                const response = await fetch(`/api/alerts?user_id=${currentUser.id}`);
                
                if (response.ok) {
                    // Session is valid, show main app
                    showMainApp();
                } else {
                    // Session is invalid, clear and show login
                    localStorage.removeItem('ranchFireAlertUser');
                    currentUser = null;
                    showUserCheck();
                }
            } catch (error) {
                console.error('Session validation error:', error);
                // On network error, still show main app (offline mode)
                showMainApp();
            }
        }

        // Database management functions
        async function loadDatabaseStatus() {
            if (!currentUser || !currentUser.is_admin) return;
            
            try {
                const response = await fetch(`/api/admin/database/status?user_id=${currentUser.id}`);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    displayDatabaseStatus(result.database);
                } else {
                    throw new Error(result.error || 'Failed to load database status');
                }
            } catch (error) {
                console.error('Error loading database status:', error);
                document.getElementById('databaseStatus').innerHTML = 
                    '<p style="color: #f44336;">Failed to load database status: ' + error.message + '</p>';
            }
        }

        function displayDatabaseStatus(dbInfo) {
            const statusDiv = document.getElementById('databaseStatus');
            
            let backupsHtml = '';
            if (dbInfo.backups && dbInfo.backups.length > 0) {
                backupsHtml = `
                    <h4>Backups (${dbInfo.backups.length})</h4>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin: 10px 0;">
                        ${dbInfo.backups.map(backup => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #eee;">
                                <div>
                                    <strong>${backup.filename}</strong><br>
                                    <small>Size: ${(backup.size / 1024).toFixed(1)} KB</small>
                                </div>
                                <div style="text-align: right;">
                                    <small>${new Date(backup.modified).toLocaleString()}</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            statusDiv.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h4>Database Information</h4>
                    <p><strong>Type:</strong> ${dbInfo.type}</p>
                    <p><strong>Connection:</strong> ${dbInfo.uri}</p>
                    <p><strong>Tables:</strong> ${dbInfo.tables.length} tables</p>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        ${dbInfo.tables.map(table => `<li>${table}</li>`).join('')}
                    </ul>
                </div>
                ${backupsHtml}
            `;
        }

        async function createDatabaseBackup() {
            if (!currentUser || !currentUser.is_admin) return;
            
            if (!confirm('Create a database backup? This may take a moment.')) return;
            
            try {
                const response = await fetch(`/api/admin/database/backup?user_id=${currentUser.id}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Database backup created successfully!');
                    loadDatabaseStatus(); // Refresh status to show new backup
                } else {
                    throw new Error(result.error || 'Failed to create backup');
                }
            } catch (error) {
                console.error('Error creating database backup:', error);
                showError('Failed to create backup: ' + error.message);
            }
        }

        // --- User Management Functions ---
        async function loadUsers() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '<p>Loading users...</p>';
            try {
                const response = await fetch(`/api/admin/users?user_id=${currentUser.id}`);
                const result = await response.json();
                if (result.success) {
                    if (result.users.length === 0) {
                        usersList.innerHTML = '<p>No users found.</p>';
                        return;
                    }
                    let table = `<table class="alert-table"><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Ranch</th><th>Admin</th><th>Actions</th></tr></thead><tbody>`;
                    for (const user of result.users) {
                        table += `<tr>
                            <td>${user.name}</td>
                            <td>${user.email || ''}</td>
                            <td>${user.phone || ''}</td>
                            <td>${user.ranch_id || ''}</td>
                            <td>${user.is_admin ? 'Yes' : 'No'}</td>
                            <td>
                                <button class='btn btn-secondary' onclick='showEditUserModal(${user.id})'>Edit</button>
                                <button class='btn btn-danger' onclick='deleteUser(${user.id})'>Delete</button>
                            </td>
                        </tr>`;
                    }
                    table += '</tbody></table>';
                    usersList.innerHTML = table;
                } else {
                    usersList.innerHTML = `<p style='color:#B22222;'>${result.error || 'Failed to load users.'}</p>`;
                }
            } catch (error) {
                usersList.innerHTML = `<p style='color:#B22222;'>Error loading users: ${error.message}</p>`;
            }
        }

        // --- User Management Modal Logic ---
        let editingUserId = null;
        function showAddUserModal() {
            editingUserId = null;
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPhone').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userIsAdmin').checked = false;
            loadRanchOptions('userRanch');
            document.getElementById('userModal').classList.remove('hidden');
        }
        async function showEditUserModal(userId) {
            editingUserId = userId;
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userPassword').value = '';
            loadRanchOptions('userRanch');
            try {
                const response = await fetch(`/api/admin/users?user_id=${currentUser.id}`);
                const result = await response.json();
                if (result.success) {
                    const user = result.users.find(u => u.id === userId);
                    if (!user) return;
                    document.getElementById('userName').value = user.name || '';
                    document.getElementById('userEmail').value = user.email || '';
                    document.getElementById('userPhone').value = user.phone || '';
                    document.getElementById('userIsAdmin').checked = !!user.is_admin;
                    document.getElementById('userRanch').value = user.ranch_id || '';
                    document.getElementById('userModal').classList.remove('hidden');
                }
            } catch {}
        }
        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }
        async function saveUser() {
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            const password = document.getElementById('userPassword').value;
            const ranch_id = document.getElementById('userRanch').value;
            const is_admin = document.getElementById('userIsAdmin').checked;
            if (!name || !ranch_id) {
                alert('Name and Ranch are required.');
                return;
            }
            const payload = { name, email, phone, password, ranch_id, is_admin };
            let url = '/api/admin/users', method = 'POST';
            if (editingUserId) {
                url = `/api/admin/users/${editingUserId}`;
                method = 'PUT';
            }
            try {
                const response = await fetch(url + `?user_id=${currentUser.id}`, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.success) {
                    closeUserModal();
                    loadUsers();
                } else {
                    alert(result.error || 'Failed to save user.');
                }
            } catch (error) {
                alert('Error saving user: ' + error.message);
            }
        }
        async function deleteUser(userId) {
            if (!confirm('Delete this user?')) return;
            try {
                const response = await fetch(`/api/admin/users/${userId}?user_id=${currentUser.id}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    loadUsers();
                } else {
                    alert(result.error || 'Failed to delete user.');
                }
            } catch (error) {
                alert('Error deleting user: ' + error.message);
            }
        }
        async function loadRanchOptions(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Loading...</option>';
            try {
                const response = await fetch('/api/ranches');
                const result = await response.json();
                if (result.success) {
                    select.innerHTML = '';
                    for (const ranch of result.ranches) {
                        select.innerHTML += `<option value="${ranch.id}">${ranch.name}</option>`;
                    }
                } else {
                    select.innerHTML = '<option value="">Failed to load ranches</option>';
                }
            } catch {
                select.innerHTML = '<option value="">Failed to load ranches</option>';
            }
        }

        window.showEditUserModal = showEditUserModal;
        window.showAddUserModal = showAddUserModal;
        window.deleteUser = deleteUser;
        window.closeUserModal = closeUserModal;
    </script>
</body>
</html>